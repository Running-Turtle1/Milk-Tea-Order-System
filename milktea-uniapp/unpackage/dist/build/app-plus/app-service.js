if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((o=>t.resolve(e()).then((()=>o))),(o=>t.resolve(e()).then((()=>{throw o}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...o){uni.__log__?uni.__log__(e,t,...o):console[e].apply(console,[...o,t])}const o="http://192.168.9.84:8081/api",a={request:null,response:null},s=e=>{let s={url:"",method:"GET",data:{},header:{"content-type":"application/json"},...e};s.url.startsWith("http")||(s.url=`${o}${s.url.startsWith("/")?"":"/"}${s.url}`);const n=uni.getStorageSync("token");if(n)try{const e=1e3*JSON.parse(atob(n.split(".")[1])).exp;if((new Date).getTime()>=e-3e5)throw t("log","at utils/api.js:71","Token已过期或即将过期，跳转到登录页面"),uni.removeStorageSync("token"),uni.showToast({title:"登录已过期，请重新登录",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500),new Error("Token expired");s.header={...s.header,Authorization:`Bearer ${n}`}}catch(r){t("error","at utils/api.js:100","Token解析错误:",r),"Token expired"!==r.message&&uni.removeStorageSync("token")}if(a.request){const e=a.request(s);e&&(s=e)}return new Promise(((e,o)=>{uni.request({...s,success:o=>{if("string"==typeof o.data&&o.data.includes("<!DOCTYPE html>")){t("error","at utils/api.js:124","收到HTML响应而非JSON数据，可能是认证问题"),uni.removeStorageSync("token");const a={...o,statusCode:401,data:{code:401,message:"请先登录或登录已过期"}};return uni.showToast({title:"请先登录或登录已过期",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500),void e(a)}if((401===o.statusCode||o.data&&401===o.data.code)&&(uni.removeStorageSync("token"),uni.showToast({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)),a.response){const t=a.response(o);if(t)return void e(t)}e(o)},fail:e=>{t("error","at utils/api.js:183","请求失败:",e),o(e)}})}))},n={getShopInfo:()=>s({url:"/shop/info",method:"GET"}),getCategories:()=>s({url:"/product/categories",method:"GET"}),getCategoryProducts:(e,t,o)=>s({url:"/product/list",method:"GET",data:{categoryId:e,page:t,size:o}}),getRecommendProducts:()=>s({url:"/product/recommend",method:"GET"}),getProductDetail:e=>s({url:`/product/detail/${e}`,method:"GET"}),getIngredients:()=>s({url:"/ingredient/list",method:"GET"}),login:(e,t)=>s({url:"/user/login",method:"POST",data:{username:e,password:t}}),register:e=>s({url:"/user/register",method:"POST",data:e}),getUserInfo:()=>s({url:"/user/profile",method:"GET"}),updateUserInfo:e=>s({url:"/user/update",method:"POST",data:e}),uploadAvatar:e=>new Promise(((t,a)=>{const s=uni.getStorageSync("token");uni.uploadFile({url:`${o}/files/avatar`,filePath:e,name:"file",header:s?{Authorization:`Bearer ${s}`}:{},success:e=>{if("string"==typeof e.data)try{const o=JSON.parse(e.data);t(o)}catch(o){t(e.data)}else t(e.data)},fail:e=>{a(e)}})})),createOrder:e=>s({url:"/order/create",method:"POST",data:e}),getOrders:(e,t,o)=>{const a={page:t,size:o};return null!=e&&(a.status=e),s({url:"/order/list",method:"GET",data:a})},getOrderDetail:e=>s({url:`/order/detail/${e}`,method:"GET"}),cancelOrder:e=>s({url:`/order/cancel/${e}`,method:"POST"}),payOrder:(e,o)=>(t("log","at utils/api.js:360","API开始调用支付接口，支付方式:",o,"订单号:",e),s({url:`/order/pay/${e}?paymentMethod=${o}`,method:"POST",data:{}})),getPointsRecords:(e,t)=>s({url:"/user/points/records",method:"GET",data:{page:e,size:t}}),getCoupons:e=>s({url:"/user/coupons",method:"GET",data:{status:e}}),exchangeCoupon:e=>s({url:"/user/exchange-coupon",method:"POST",data:{code:e}}),refreshCoupons:()=>s({url:"/user/coupons",method:"GET"}),getCart:()=>s({url:"/cart",method:"GET"}),clearSelectedCartItems:()=>s({url:"/cart/selected",method:"DELETE"}),verifyCartStock:()=>s({url:"/cart/verify-stock",method:"GET"}),deleteOrder:e=>s({url:`/order/${e}`,method:"DELETE"}),applyRefund:e=>s({url:"/refund/apply",method:"POST",data:e}),getMemberInfo:()=>s({url:"/member/info",method:"GET"})},r={baseUrl:o,getBaseUrl:()=>o,request:s,processImageUrl:e=>e&&e.includes("/api/uploads/")?e+(e.includes("?")?"&":"?")+"t="+(new Date).getTime():e,setRequestInterceptor:e=>{a.request=e},setResponseInterceptor:e=>{a.response=e},...n},i=(e,t)=>{const o=e.__vccOpts||e;for(const[a,s]of t)o[a]=s;return o};const c=i({data:()=>({networkError:!1,tableNumber:"",shopInfo:{}}),onLoad(){this.loadHomeData()},onShow(){this.loadHomeData()},onPullDownRefresh(){this.loadHomeData(),uni.stopPullDownRefresh()},methods:{loadHomeData(){this.networkError=!1,this.getShopInfo()},getShopInfo(){r.getShopInfo().then((e=>{200===e.data.code?this.shopInfo=e.data.data:this.showError(e.data.message)})).catch((()=>{this.networkError=!0}))},callShop(){this.shopInfo.phone&&uni.makePhoneCall({phoneNumber:this.shopInfo.phone,fail:()=>{}})},goToMenu(){uni.switchTab({url:"/pages/menu/menu"})},retryLoad(){this.loadHomeData()},showError(e){uni.showToast({title:e||"操作失败",icon:"none"})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"home-container"},[e.createElementVNode("swiper",{class:"banner-swiper",circular:"","indicator-dots":!0,autoplay:!0,interval:3e3,duration:1e3},[e.createElementVNode("swiper-item",null,[e.createElementVNode("image",{src:n.shopInfo.logo||"/static/logo.png",mode:"aspectFill",class:"banner-image"},null,8,["src"])])]),n.shopInfo.id?(e.openBlock(),e.createElementBlock("view",{key:0,class:"shop-info-card"},[e.createElementVNode("view",{class:"shop-header"},[e.createElementVNode("view",{class:"shop-name"},e.toDisplayString(n.shopInfo.shopName),1),e.createElementVNode("view",{class:"shop-hours"},"营业时间: "+e.toDisplayString(n.shopInfo.businessHours),1)]),e.createElementVNode("view",{class:"shop-body"},[e.createElementVNode("view",{class:"shop-notice"},e.toDisplayString(n.shopInfo.notice),1),e.createElementVNode("view",{class:"shop-contact"},[e.createElementVNode("view",{class:"shop-address"},[e.createElementVNode("image",{src:"/static/icons/common/location-white.svg",class:"contact-icon"}),e.createElementVNode("text",null,e.toDisplayString(n.shopInfo.address),1)]),e.createElementVNode("view",{class:"shop-phone",onClick:o[0]||(o[0]=(...e)=>r.callShop&&r.callShop(...e))},[e.createElementVNode("image",{src:"/static/icons/common/phone.svg",class:"contact-icon",style:{width:"28rpx",height:"28rpx"}}),e.createElementVNode("text",null,e.toDisplayString(n.shopInfo.phone),1)])])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"store-order-tip"},[e.createElementVNode("view",{class:"tip-icon"},[e.createElementVNode("image",{src:"/static/icons/common/shop.svg",class:"tip-icon-img"})]),e.createElementVNode("view",{class:"tip-text"},[e.createElementVNode("text",{class:"tip-title"},"欢迎光临"),e.createElementVNode("text",{class:"tip-desc"},"店内点单更便捷")]),e.createElementVNode("view",{class:"tip-btn"},[e.createElementVNode("button",{size:"mini",type:"primary",onClick:o[1]||(o[1]=(...e)=>r.goToMenu&&r.goToMenu(...e))},"去点餐")])]),e.createElementVNode("view",{class:"quick-entry-wrapper"},[e.createElementVNode("view",{class:"entry-item",onClick:o[2]||(o[2]=(...e)=>r.goToMenu&&r.goToMenu(...e))},[e.createElementVNode("view",{class:"entry-icon-wrapper drink"},[e.createElementVNode("image",{src:"/static/icons/common/coffee.svg",class:"entry-icon-img"})]),e.createElementVNode("text",{class:"entry-text"},"今天喝点啥")]),e.createElementVNode("view",{class:"entry-item",onClick:o[3]||(o[3]=(...e)=>r.goToMenu&&r.goToMenu(...e))},[e.createElementVNode("view",{class:"entry-icon-wrapper new"},[e.createElementVNode("image",{src:"/static/icons/common/new.svg",class:"entry-icon-img"})]),e.createElementVNode("text",{class:"entry-text"},"新品上线")]),e.createElementVNode("view",{class:"entry-item",onClick:o[4]||(o[4]=(...e)=>r.goToMenu&&r.goToMenu(...e))},[e.createElementVNode("view",{class:"entry-icon-wrapper free"},[e.createElementVNode("image",{src:"/static/icons/common/gift.svg",class:"entry-icon-img"})]),e.createElementVNode("text",{class:"entry-text"},"0元兑换")])]),n.networkError?(e.openBlock(),e.createElementBlock("view",{key:1,class:"network-error"},[e.createElementVNode("text",{class:"error-text"},"网络连接失败，请检查网络设置"),e.createElementVNode("button",{size:"mini",type:"primary",onClick:o[5]||(o[5]=(...e)=>r.retryLoad&&r.retryLoad(...e))},"重试")])):e.createCommentVNode("",!0)])}]]),l="/static/icons/common/search.svg",d="/static/icons/common/add.svg",m="/static/icons/common/close.svg",u="/static/icons/common/temperature.svg",h="/static/icons/common/sweetness.svg",p="/static/icons/common/ingredients.svg",g="/static/icons/common/quantity.svg";const w=i({data:()=>({categories:[],currentCategoryIndex:0,scrollToId:"",recommendProducts:[],categoryProducts:{},categoryPages:{},categoryLoadingStatus:{},showDetail:!1,currentProduct:{},quantity:1,popupStyle:{transform:"translateY(100%)",transition:"none"},maskStyle:{opacity:0,transition:"none"},contentStyle:{opacity:0,transition:"none"},temperatures:["常温","热","冰","少冰"],sweetness:["标准糖","少糖","半糖","微糖","无糖"],ingredients:[],selectedTemp:"常温",selectedSweet:"标准糖",selectedIngredients:[]}),onLoad(e){this.loadCategories(),this.loadRecommendProducts(),this.loadIngredients(),this.popupAnimation=uni.createAnimation({duration:1e3,timingFunction:"ease-out",delay:0}),e.productId&&this.loadProductDetail(e.productId)},methods:{loadCategories(){r.getCategories().then((e=>{t("log","at pages/menu/menu.vue:275","获取商品分类响应:",e.data),200===e.data.code?(this.categories=[{id:0,name:"全部"},...e.data.data],this.categories.forEach((e=>{0!==e.id&&(this.categoryProducts[e.id]=[],this.categoryPages[e.id]=0,this.categoryLoadingStatus[e.id]="more",this.loadCategoryProducts(e.id))}))):this.showToast(e.data.message||"获取商品分类失败")})).catch((e=>{t("error","at pages/menu/menu.vue:299","网络请求失败:",e),this.showToast("网络请求失败")}))},loadRecommendProducts(){r.getRecommendProducts().then((e=>{t("log","at pages/menu/menu.vue:308","获取推荐商品响应:",e.data),200===e.data.code?this.recommendProducts=e.data.data:this.showToast(e.data.message||"获取推荐商品失败")})).catch((e=>{t("error","at pages/menu/menu.vue:316","网络请求失败:",e),this.showToast("网络请求失败")}))},loadIngredients(){r.getIngredients().then((e=>{t("log","at pages/menu/menu.vue:325","获取配料列表响应:",e.data),200===e.data.code?this.ingredients=e.data.data:this.showToast(e.data.message||"获取配料列表失败")})).catch((e=>{t("error","at pages/menu/menu.vue:333","网络请求失败:",e),this.showToast("网络请求失败")}))},loadCategoryProducts(e,o=!1){if("loading"===this.categoryLoadingStatus[e]||"noMore"===this.categoryLoadingStatus[e])return;this.categoryLoadingStatus[e]="loading";const a=o?this.categoryPages[e]+1:this.categoryPages[e];r.getCategoryProducts(e,a,10).then((s=>{if(t("log","at pages/menu/menu.vue:351",`获取分类${e}商品响应:`,s.data),200===s.data.code){const t=s.data.data;this.categoryProducts[e]=o?[...this.categoryProducts[e],...t.content]:t.content,this.categoryPages[e]=a,t.last?this.categoryLoadingStatus[e]="noMore":this.categoryLoadingStatus[e]="more"}else this.showToast(s.data.message||"获取分类商品失败"),this.categoryLoadingStatus[e]="more"})).catch((o=>{t("error","at pages/menu/menu.vue:377","网络请求失败:",o),this.showToast("网络请求失败"),this.categoryLoadingStatus[e]="more"}))},switchCategory(e){if(this.currentCategoryIndex=e,0===e)return;const t=this.categories[e].id;this.scrollToId="category-section-"+t},loadMoreProducts(){if(0===this.currentCategoryIndex)return;const e=this.categories[this.currentCategoryIndex].id;this.loadCategoryProducts(e,!0)},loadProductDetail(e){r.getProductDetail(e).then((e=>{200===e.data.code?(this.currentProduct=e.data.data,this.resetProductOptions(),this.openDetailPopup()):this.showToast(e.data.message||"获取商品详情失败")})).catch((e=>{t("error","at pages/menu/menu.vue:418","网络请求失败:",e),this.showToast("网络请求失败")}))},showProductDetail(e){this.resetProductOptions(),this.showDetail=!0,this.popupStyle={transform:"translateY(100%)",transition:"none"},this.maskStyle={opacity:0,transition:"none"},this.contentStyle={opacity:0,transition:"none"},this.$nextTick((()=>{setTimeout((()=>{r.getProductDetail(e.id).then((e=>{t("log","at pages/menu/menu.vue:450","获取商品详情响应:",e.data),200===e.data.code?(this.currentProduct=e.data.data,this.openDetailPopup()):(this.showToast(e.data.message||"获取商品详情失败"),this.showDetail=!1)})).catch((e=>{t("error","at pages/menu/menu.vue:463","网络请求失败:",e),this.showToast("网络请求失败"),this.showDetail=!1}))}),50)}))},openDetailPopup(){this.maskStyle={opacity:1,transition:"opacity 0.2s ease-out"},setTimeout((()=>{this.popupStyle={transform:"translateY(0)",transition:"transform 0.3s ease-out"},setTimeout((()=>{this.contentStyle={opacity:1,transition:"opacity 0.2s ease-out"}}),150)}),100)},hideProductDetail(){this.contentStyle={opacity:0,transition:"opacity 0.2s ease-in"},setTimeout((()=>{this.popupStyle={transform:"translateY(100%)",transition:"transform 0.3s ease-in"},setTimeout((()=>{this.maskStyle={opacity:0,transition:"opacity 0.2s ease-in"},setTimeout((()=>{this.showDetail=!1}),200)}),150)}),100)},resetProductOptions(){this.quantity=1,this.selectedTemp="常温",this.selectedSweet="标准糖",this.selectedIngredients=[]},adjustQuantity(e){const t=this.quantity+e;t>=1&&t<=99&&(this.quantity=t)},toggleIngredient(e){const o=this.selectedIngredients.findIndex((t=>t.id===e.id));if(o>-1)this.selectedIngredients.splice(o,1);else{const o={id:e.id,name:e.name,price:e.price};t("log","at pages/menu/menu.vue:554","添加配料:",o),this.selectedIngredients.push(o)}},getTotalPrice(){if(!this.currentProduct.price)return 0;let e=this.currentProduct.price*this.quantity;return this.selectedIngredients.forEach((t=>{e+=t.price*this.quantity})),e},addToCart(){if(!uni.getStorageSync("token"))return void uni.showModal({title:"未登录提示",content:"您尚未登录，是否前往登录页面？",confirmText:"去登录",cancelText:"取消",success:e=>{e.confirm&&this.redirectToLogin()}});let e=[];this.selectedIngredients&&this.selectedIngredients.length>0&&(e=this.selectedIngredients.map((e=>({id:e.id,name:e.name,price:e.price})))),t("log","at pages/menu/menu.vue:605","商品是否允许温度选择:",this.currentProduct.allowTemperature),t("log","at pages/menu/menu.vue:606","商品是否允许甜度选择:",this.currentProduct.allowSweetness),t("log","at pages/menu/menu.vue:607","商品可能的其他控制字段:",Object.keys(this.currentProduct).filter((e=>e.startsWith("allow")))),t("log","at pages/menu/menu.vue:610","用户选择的温度:",this.selectedTemp),t("log","at pages/menu/menu.vue:611","用户选择的甜度:",this.selectedSweet);t("log","at pages/menu/menu.vue:615","规格组合标识:",`${this.selectedTemp}-${this.selectedSweet}-${e.map((e=>e.id)).join(",")}`);const o={productId:this.currentProduct.id,quantity:this.quantity,temperature:this.selectedTemp,sweetness:this.selectedSweet,ingredients:e,forceNewItem:!0,selected:!0};t("log","at pages/menu/menu.vue:628","当前选择的配料原始数据:",this.selectedIngredients),t("log","at pages/menu/menu.vue:629","处理后的配料数据:",e),t("log","at pages/menu/menu.vue:630","发送到购物车的数据:",o),t("log","at pages/menu/menu.vue:631","当前商品是否允许配料:",this.currentProduct.allowIngredients),t("log","at pages/menu/menu.vue:632","当前商品完整信息:",this.currentProduct),r.request({url:"/cart",method:"POST",data:o}).then((e=>{t("log","at pages/menu/menu.vue:639","添加到购物车响应:",e.data),200===e.data.code?(this.showToast("已添加到购物车","success"),this.hideProductDetail()):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"添加到购物车失败")})).catch((e=>{t("error","at pages/menu/menu.vue:649","网络请求失败:",e),this.showToast("网络请求失败")}))},goToSearch(){uni.navigateTo({url:"/pages/menu/search"})},redirectToLogin(){uni.navigateTo({url:"/pages/login/login"})},handleTokenExpired(){uni.removeStorageSync("token"),uni.showToast({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>{this.redirectToLogin()}),1500)},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"menu-container"},[e.createElementVNode("view",{class:"search-bar"},[e.createElementVNode("view",{class:"search-box",onClick:o[0]||(o[0]=(...e)=>r.goToSearch&&r.goToSearch(...e))},[e.createElementVNode("image",{src:l,class:"search-icon"}),e.createElementVNode("text",{class:"search-placeholder"},"搜索奶茶、果茶、小吃")])]),e.createElementVNode("view",{class:"content-with-categories"},[e.createElementVNode("scroll-view",{"scroll-y":"",class:"category-nav"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.categories,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:e.normalizeClass(["category-item",n.currentCategoryIndex===o?"active":""]),onClick:e=>r.switchCategory(o)},[e.createElementVNode("text",null,e.toDisplayString(t.name),1)],10,["onClick"])))),128))]),e.createElementVNode("scroll-view",{"scroll-y":"",class:"product-list",onScrolltolower:o[1]||(o[1]=(...e)=>r.loadMoreProducts&&r.loadMoreProducts(...e)),"scroll-into-view":n.scrollToId},[0===n.currentCategoryIndex?(e.openBlock(),e.createElementBlock("view",{key:0,class:"section"},[e.createElementVNode("view",{class:"section-title"},[e.createElementVNode("text",null,"推荐商品")]),e.createElementVNode("view",{class:"product-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.recommendProducts,(t=>(e.openBlock(),e.createElementBlock("view",{class:"product-card",key:t.id,onClick:e=>r.showProductDetail(t)},[e.createElementVNode("image",{src:t.image||"/static/images/default-product.svg",class:"product-image",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"product-info"},[e.createElementVNode("text",{class:"product-name"},e.toDisplayString(t.name),1),e.createElementVNode("view",{class:"product-price-row"},[e.createElementVNode("text",{class:"product-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1),e.createElementVNode("view",{class:"add-to-cart-btn",onClick:e.withModifiers((e=>r.showProductDetail(t)),["stop"])},[e.createElementVNode("image",{src:d,class:"add-icon"})],8,["onClick"])])])],8,["onClick"])))),128))])])):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.categories,((t,o)=>e.withDirectives((e.openBlock(),e.createElementBlock("view",{class:"section",key:t.id,id:"category-section-"+t.id},[e.createElementVNode("view",{class:"section-title"},[e.createElementVNode("text",null,e.toDisplayString(t.name),1)]),e.createElementVNode("view",{class:"product-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.categoryProducts[t.id]||[],(t=>(e.openBlock(),e.createElementBlock("view",{class:"product-card",key:t.id,onClick:e=>r.showProductDetail(t)},[e.createElementVNode("image",{src:t.image||"/static/images/default-product.svg",class:"product-image",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"product-info"},[e.createElementVNode("text",{class:"product-name"},e.toDisplayString(t.name),1),e.createElementVNode("view",{class:"product-price-row"},[e.createElementVNode("text",{class:"product-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1),e.createElementVNode("view",{class:"add-to-cart-btn",onClick:e.withModifiers((e=>r.showProductDetail(t)),["stop"])},[e.createElementVNode("image",{src:d,class:"add-icon"})],8,["onClick"])])])],8,["onClick"])))),128))]),"loading"===n.categoryLoadingStatus[t.id]?(e.openBlock(),e.createElementBlock("view",{key:0,class:"load-more"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",null,"加载中...")])):"noMore"===n.categoryLoadingStatus[t.id]?(e.openBlock(),e.createElementBlock("view",{key:1,class:"load-more"},[e.createElementVNode("text",null,"已加载全部")])):e.createCommentVNode("",!0)],8,["id"])),[[e.vShow,0===n.currentCategoryIndex||n.currentCategoryIndex===o]]))),128))],40,["scroll-into-view"])]),e.withDirectives(e.createElementVNode("view",{class:"product-detail-popup"},[e.createElementVNode("view",{class:"popup-mask",onClick:o[2]||(o[2]=(...e)=>r.hideProductDetail&&r.hideProductDetail(...e)),style:e.normalizeStyle(n.maskStyle)},null,4),e.createElementVNode("view",{class:"popup-content",style:e.normalizeStyle(n.popupStyle)},[e.createElementVNode("view",{class:"popup-inner",style:e.normalizeStyle(n.contentStyle)},[e.createElementVNode("view",{class:"close-btn",onClick:o[3]||(o[3]=(...e)=>r.hideProductDetail&&r.hideProductDetail(...e))},[e.createElementVNode("image",{src:m,class:"close-icon"})]),e.createElementVNode("view",{class:"detail-header"},[e.createElementVNode("image",{src:n.currentProduct.image||"/static/images/default-product.svg",class:"detail-image",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"detail-basic-info"},[e.createElementVNode("view",{class:"name-price-row"},[e.createElementVNode("text",{class:"detail-name"},e.toDisplayString(n.currentProduct.name),1),e.createElementVNode("text",{class:"detail-price"},"¥"+e.toDisplayString(n.currentProduct.price?n.currentProduct.price.toFixed(2):"0.00"),1)]),n.currentProduct.sales?(e.openBlock(),e.createElementBlock("text",{key:0,class:"detail-sales"},"销量: "+e.toDisplayString(n.currentProduct.sales),1)):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:"specifications"},[e.createElementVNode("view",{class:"spec-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:u,class:"spec-icon"}),e.createElementVNode("text",{class:"spec-title"},"温度")]),e.createElementVNode("view",{class:"spec-options"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.temperatures,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["spec-option",n.selectedTemp===t?"selected":""]),onClick:e=>n.selectedTemp=t},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))])]),e.createElementVNode("view",{class:"spec-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:h,class:"spec-icon"}),e.createElementVNode("text",{class:"spec-title"},"甜度")]),e.createElementVNode("view",{class:"spec-options"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.sweetness,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["spec-option",n.selectedSweet===t?"selected":""]),onClick:e=>n.selectedSweet=t},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))])]),n.ingredients.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"spec-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:p,class:"spec-icon"}),e.createElementVNode("text",{class:"spec-title"},"加料")]),e.createElementVNode("view",{class:"ingredient-options"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.ingredients,(t=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:e.normalizeClass(["ingredient-item",n.selectedIngredients.findIndex((e=>e.id===t.id))>-1?"selected":""]),onClick:e=>r.toggleIngredient(t)},[e.createElementVNode("text",{class:"ingredient-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:"ingredient-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1)],10,["onClick"])))),128))])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"quantity-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:g,class:"spec-icon"}),e.createElementVNode("text",{class:"quantity-label"},"数量")]),e.createElementVNode("view",{class:"quantity-control"},[e.createElementVNode("text",{class:"quantity-btn minus",onClick:o[4]||(o[4]=e=>r.adjustQuantity(-1))},"-"),e.withDirectives(e.createElementVNode("input",{type:"number",class:"quantity-input","onUpdate:modelValue":o[5]||(o[5]=e=>n.quantity=e),disabled:""},null,512),[[e.vModelText,n.quantity]]),e.createElementVNode("text",{class:"quantity-btn plus",onClick:o[6]||(o[6]=e=>r.adjustQuantity(1))},"+")])]),e.createElementVNode("view",{class:"detail-footer"},[e.createElementVNode("view",{class:"total-price"},[e.createElementVNode("text",null,"总计："),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(r.getTotalPrice().toFixed(2)),1)]),e.createElementVNode("view",{class:"add-to-cart",onClick:o[7]||(o[7]=(...e)=>r.addToCart&&r.addToCart(...e))},[e.createElementVNode("text",null,"加入购物车")])])],4)],4)],512),[[e.vShow,n.showDetail]])])}],["__scopeId","data-v-278b89bf"]]);const v=i({data:()=>({cartInfo:{items:[],totalPrice:0,totalQuantity:0,selectedTotalPrice:0,selectedTotalQuantity:0,allProductsAvailable:!0},isEditMode:!1,loading:!1,deleteButtonWidth:70,touchStartX:0,touchStartY:0,direction:"",activeIndex:-1,isMoving:!1}),computed:{allSelected(){return!(!this.cartInfo.items||0===this.cartInfo.items.length)&&this.cartInfo.items.every((e=>e.selected))}},onShow(){this.fetchCartData()},methods:{calculateItemTotalPrice(e){let t=e.productPrice||0;if(e.ingredients&&e.ingredients.length>0){t+=e.ingredients.reduce(((e,t)=>e+(parseFloat(t.price)||0)),0)}return t},fetchCartData(){this.loading=!0;if(!uni.getStorageSync("token"))return this.loading=!1,void uni.showModal({title:"未登录提示",content:"您尚未登录，是否前往登录页面？",confirmText:"去登录",cancelText:"取消",success:e=>{e.confirm?this.redirectToLogin():uni.switchTab({url:"/pages/menu/menu"})}});r.request({url:"/cart",method:"GET"}).then((e=>{t("log","at pages/cart/cart.vue:196","获取购物车响应:",e.data),200===e.data.code?(this.cartInfo=e.data.data,this.cartInfo.items||(this.cartInfo.items=[])):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"获取购物车失败")})).catch((e=>{t("error","at pages/cart/cart.vue:212","网络请求失败:",e),this.showToast("网络请求失败")})).finally((()=>{this.loading=!1}))},adjustQuantity(e,o){o<1&&(o=1);const a=this.cartInfo.items.findIndex((t=>t.id===e));if(-1===a)return void this.showToast("找不到商品信息");const s=this.cartInfo.items[a];r.request({url:`/cart/${e}`,method:"PUT",data:{productId:s.productId,quantity:o,temperature:s.temperature||"",sweetness:s.sweetness||"",ingredients:s.ingredients||[]}}).then((e=>{t("log","at pages/cart/cart.vue:247","更新购物车响应:",e.data),200===e.data.code?this.cartInfo=e.data.data:401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"更新购物车失败")})).catch((e=>{t("error","at pages/cart/cart.vue:257","网络请求失败:",e),this.showToast("网络请求失败")}))},toggleItemSelect(e,o){r.request({url:`/cart/select/${e}?selected=${o}`,method:"PUT"}).then((e=>{t("log","at pages/cart/cart.vue:269","切换选中状态响应:",e.data),200===e.data.code?this.cartInfo=e.data.data:401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"更新选中状态失败")})).catch((e=>{t("error","at pages/cart/cart.vue:279","网络请求失败:",e),this.showToast("网络请求失败")}))},toggleSelectAll(e){r.request({url:`/cart/select-all?selected=${e}`,method:"PUT"}).then((e=>{t("log","at pages/cart/cart.vue:291","全选/取消全选响应:",e.data),200===e.data.code?this.cartInfo=e.data.data:401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"操作失败")})).catch((e=>{t("error","at pages/cart/cart.vue:301","网络请求失败:",e),this.showToast("网络请求失败")}))},removeItem(e){uni.showModal({title:"提示",content:"确定要从购物车中移除该商品吗？",success:o=>{o.confirm&&r.request({url:`/cart/${e}`,method:"DELETE"}).then((e=>{t("log","at pages/cart/cart.vue:318","移除商品响应:",e.data),200===e.data.code?(this.cartInfo=e.data.data,this.resetSwipeStatus(),this.showToast("删除成功","success")):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"移除商品失败")})).catch((e=>{t("error","at pages/cart/cart.vue:330","网络请求失败:",e),this.showToast("网络请求失败")}))}})},removeSelectedItems(){0!==this.cartInfo.selectedTotalQuantity?uni.showModal({title:"提示",content:"确定要删除选中的商品吗？",success:e=>{e.confirm&&r.request({url:"/cart/selected",method:"DELETE"}).then((e=>{t("log","at pages/cart/cart.vue:355","删除选中商品响应:",e.data),200===e.data.code?(this.cartInfo=e.data.data,this.resetSwipeStatus(),this.showToast("删除成功","success")):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"删除选中商品失败")})).catch((e=>{t("error","at pages/cart/cart.vue:367","网络请求失败:",e),this.showToast("网络请求失败")}))}}):this.showToast("请选择要删除的商品")},clearCart(){0!==this.cartInfo.totalQuantity?uni.showModal({title:"提示",content:"确定要清空购物车吗？",success:e=>{e.confirm&&r.request({url:"/cart",method:"DELETE"}).then((e=>{t("log","at pages/cart/cart.vue:392","清空购物车响应:",e.data),200===e.data.code?(this.cartInfo=e.data.data,this.showToast("已清空购物车","success")):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"清空购物车失败")})).catch((e=>{t("error","at pages/cart/cart.vue:403","网络请求失败:",e),this.showToast("网络请求失败")}))}}):this.showToast("购物车已经是空的了")},checkStock(){return 0!==this.cartInfo.selectedTotalQuantity||(this.showToast("请先选择商品"),!1)},async checkout(){if(0!==this.cartInfo.selectedTotalQuantity)try{const e=this.cartInfo.items.filter((e=>e.selected)).map((e=>(e.productPrice||"number"==typeof e.productPrice||t("error","at pages/cart/cart.vue:433","商品缺少价格信息:",e),{...e,price:e.productPrice||0,quantity:e.quantity||1,ingredients:Array.isArray(e.ingredients)?e.ingredients:[]})));t("log","at pages/cart/cart.vue:446","传递到确认订单页面的商品数据:",e),uni.navigateTo({url:`/pages/order/confirm?items=${encodeURIComponent(JSON.stringify(e))}`})}catch(e){t("error","at pages/cart/cart.vue:453","结算前检查失败:",e),this.showToast("网络请求失败，请重试")}else this.showToast("请选择要结算的商品")},toggleEditMode(){this.isEditMode=!this.isEditMode},goToMenu(){uni.switchTab({url:"/pages/menu/menu"})},redirectToLogin(){uni.navigateTo({url:"/pages/login/login"})},handleTokenExpired(){uni.removeStorageSync("token"),uni.showToast({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>{this.redirectToLogin()}),1500)},showToast(e,t="none"){uni.showToast({title:e,icon:t})},touchStart(e,t){this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.direction="",this.isMoving=!1,this.activeIndex=t,this.cartInfo.items.forEach(((e,o)=>{o!==t&&e.offset&&this.$set(e,"offset",0)}))},touchMove(e,t){if(this.activeIndex!==t)return;const o=e.touches[0].clientX,a=e.touches[0].clientY,s=o-this.touchStartX,n=a-this.touchStartY;if(!this.direction){if(!(Math.abs(s)>Math.abs(n)&&Math.abs(s)>5))return void(this.direction="vertical");this.direction="horizontal"}if("horizontal"===this.direction){this.isMoving=!0;let o=s;s>0&&!(this.cartInfo.items[t].offset<0)&&(o=0),o<-72&&(o=-72),this.$set(this.cartInfo.items[t],"offset",o),e.preventDefault()}},touchEnd(e,t){if(this.activeIndex!==t||!this.isMoving)return;const o=this.cartInfo.items[t];(o.offset||0)<-20?this.$set(o,"offset",-72):this.$set(o,"offset",0),this.isMoving=!1},closeAllSwipe(){this.cartInfo.items&&this.cartInfo.items.forEach(((e,t)=>{e.offset&&this.$set(e,"offset",0)}))},resetSwipeStatus(){this.closeAllSwipe()}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"cart-container"},[n.cartInfo.items&&0===n.cartInfo.items.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-cart"},[e.createElementVNode("image",{src:"/static/tabbar/cart.png",class:"empty-icon"}),e.createElementVNode("text",{class:"empty-text"},"购物车空空如也"),e.createElementVNode("view",{class:"go-shopping-btn",onClick:o[0]||(o[0]=(...e)=>r.goToMenu&&r.goToMenu(...e))},[e.createElementVNode("button",{type:"primary",size:"mini"},"去选购")])])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"cart-content",onClick:o[5]||(o[5]=(...e)=>r.closeAllSwipe&&r.closeAllSwipe(...e))},[e.createElementVNode("view",{class:"cart-header"},[e.createElementVNode("text",{class:"cart-title"},"购物车"),e.createElementVNode("text",{class:"edit-btn",onClick:o[1]||(o[1]=(...e)=>r.toggleEditMode&&r.toggleEditMode(...e))},e.toDisplayString(n.isEditMode?"完成":"编辑"),1)]),e.createElementVNode("scroll-view",{"scroll-y":"",class:"cart-list",onTouchstart:e.withModifiers((()=>{}),["stop"])},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.cartInfo.items,((t,o)=>(e.openBlock(),e.createElementBlock("view",{class:"cart-item-wrapper",key:o,onTouchstart:e=>r.touchStart(e,o),onTouchmove:e=>r.touchMove(e,o),onTouchend:e=>r.touchEnd(e,o)},[e.createElementVNode("view",{class:"delete-button",onClick:e.withModifiers((e=>r.removeItem(t.id)),["stop"])},"删除",8,["onClick"]),e.createElementVNode("view",{class:"cart-item-container",style:e.normalizeStyle({transform:`translateX(${t.offset||0}px)`})},[e.createElementVNode("view",{class:"cart-item"},[e.createElementVNode("view",{class:"checkbox",onClick:e.withModifiers((e=>r.toggleItemSelect(t.id,!t.selected)),["stop"])},[e.createElementVNode("text",{class:e.normalizeClass(["checkbox-icon",t.selected?"checked":""])},null,2)],8,["onClick"]),e.createElementVNode("view",{class:"item-content"},[e.createElementVNode("image",{src:t.productImage||"/static/default-product.png",class:"item-image",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"item-details"},[e.createElementVNode("view",{class:"item-name"},e.toDisplayString(t.productName),1),e.createElementVNode("view",{class:"item-specs-container"},[t.temperature||t.sweetness?(e.openBlock(),e.createElementBlock("view",{key:0,class:"specs-row"},[e.createElementVNode("text",{class:"specs-label"},"规格："),e.createElementVNode("text",{class:"specs-value"},e.toDisplayString(t.temperature||""),1),t.temperature&&t.sweetness?(e.openBlock(),e.createElementBlock("text",{key:0,class:"specs-value"},"，")):e.createCommentVNode("",!0),e.createElementVNode("text",{class:"specs-value"},e.toDisplayString(t.sweetness||""),1)])):e.createCommentVNode("",!0),t.ingredients&&t.ingredients.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"specs-row"},[e.createElementVNode("text",{class:"specs-label"},"配料："),e.createElementVNode("text",{class:"specs-value"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.ingredients,((o,a)=>(e.openBlock(),e.createElementBlock("text",{key:a},e.toDisplayString(o.name)+e.toDisplayString(a<t.ingredients.length-1?"、":""),1)))),128))])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"price-quantity"},[e.createElementVNode("text",{class:"item-price"},"¥"+e.toDisplayString(r.calculateItemTotalPrice(t).toFixed(2)),1),e.createElementVNode("view",{class:"quantity-control"},[e.createElementVNode("text",{class:"quantity-btn minus",onClick:e.withModifiers((e=>r.adjustQuantity(t.id,t.quantity-1)),["stop"])},"-",8,["onClick"]),e.createElementVNode("input",{type:"number",class:"quantity-input",value:t.quantity,disabled:""},null,8,["value"]),e.createElementVNode("text",{class:"quantity-btn plus",onClick:e.withModifiers((e=>r.adjustQuantity(t.id,t.quantity+1)),["stop"])},"+",8,["onClick"])])])])]),n.isEditMode?(e.openBlock(),e.createElementBlock("view",{key:0,class:"delete-btn",onClick:e.withModifiers((e=>r.removeItem(t.id)),["stop"])},[e.createElementVNode("text",{class:"delete-icon"},"×")],8,["onClick"])):e.createCommentVNode("",!0)])],4)],40,["onTouchstart","onTouchmove","onTouchend"])))),128))],32),e.createElementVNode("view",{class:"cart-footer"},[e.createElementVNode("view",{class:"select-all",onClick:o[2]||(o[2]=e=>r.toggleSelectAll(!r.allSelected))},[e.createElementVNode("text",{class:e.normalizeClass(["checkbox-icon",r.allSelected?"checked":""])},null,2),e.createElementVNode("text",{class:"select-all-text"},"全选")]),n.isEditMode?(e.openBlock(),e.createElementBlock("view",{key:1,class:"footer-right"},[e.createElementVNode("view",{class:"batch-delete-btn",onClick:o[4]||(o[4]=(...e)=>r.removeSelectedItems&&r.removeSelectedItems(...e))},[e.createElementVNode("text",null,"删除所选")])])):(e.openBlock(),e.createElementBlock("view",{key:0,class:"footer-right"},[e.createElementVNode("view",{class:"price-info"},[e.createElementVNode("view",{class:"total-price"},[e.createTextVNode(" 合计: "),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(n.cartInfo.selectedTotalPrice.toFixed(2)),1)])]),e.createElementVNode("view",{class:e.normalizeClass(["checkout-btn",{disabled:0===n.cartInfo.selectedTotalQuantity}]),onClick:o[3]||(o[3]=(...e)=>r.checkout&&r.checkout(...e))},[e.createElementVNode("text",null,"结算("+e.toDisplayString(n.cartInfo.selectedTotalQuantity)+")",1)],2)]))])]))])}]]);const E=i({data:()=>({tabs:["全部","待支付","已支付","已取消","售后"],activeTab:0,orders:[],loading:!1,refreshing:!1,hasMore:!0,page:0,size:5,emptyText:"暂无订单",deleteButtonWidth:70,refundButtonWidth:100,touchStartX:0,touchStartY:0,direction:"",activeIndex:-1,isMoving:!1}),onLoad(){this.checkLoginStatus(),this.loadOrders()},onShow(){this.refreshOrders()},methods:{checkLoginStatus(){uni.getStorageSync("token")||uni.showModal({title:"未登录提示",content:"您尚未登录，是否前往登录页面？",confirmText:"去登录",cancelText:"取消",success:e=>{e.confirm?uni.navigateTo({url:"/pages/login/login"}):uni.switchTab({url:"/pages/menu/menu"})}})},switchTab(e){this.activeTab!==e&&(this.activeTab=e,this.refreshOrders())},refreshOrders(){this.orders=[],this.page=0,this.hasMore=!0,this.loadOrders()},onRefresh(){this.refreshing=!0,this.refreshOrders(),setTimeout((()=>{this.refreshing=!1}),1500)},loadOrders(){if(this.loading||!this.hasMore)return;let e;switch(this.loading=!0,this.activeTab){case 1:e=0;break;case 2:e=1;break;case 3:e=5;break;case 4:return void this.loadRefundOrders()}t("log","at pages/order/order.vue:246","请求订单列表，状态:",e,"类型:",typeof e),r.getOrders(e,this.page,this.size).then((e=>{if(t("log","at pages/order/order.vue:250","获取订单列表响应:",e.data),200===e.data.code){const t=e.data.data;this.orders=this.orders.concat(t.content||[]),t.last?this.hasMore=!1:this.page++,this.updateEmptyText()}else uni.showToast({title:e.data.message||"获取订单失败",icon:"none"})})).catch((e=>{t("error","at pages/order/order.vue:274","网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})).finally((()=>{this.loading=!1}))},loadRefundOrders(){Promise.all([r.getOrders(3,this.page,this.size),r.getOrders(4,this.page,this.size),r.getOrders(6,this.page,this.size)]).then((e=>{let t=[];e.forEach((e=>{if(e.data&&200===e.data.code&&e.data.data){const o=e.data.data;t=t.concat(o.content||[])}})),t.sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt))),this.orders=this.orders.concat(t),this.hasMore=!1,0===this.orders.length&&(this.emptyText="暂无售后订单")})).catch((e=>{t("error","at pages/order/order.vue:322","获取退款订单失败:",e),uni.showToast({title:"获取售后订单失败",icon:"none"})})).finally((()=>{this.loading=!1}))},updateEmptyText(){if(0===this.orders.length)switch(this.activeTab){case 0:default:this.emptyText="暂无订单";break;case 1:this.emptyText="暂无待支付订单";break;case 2:this.emptyText="暂无已支付订单";break;case 3:this.emptyText="暂无已取消订单";break;case 4:this.emptyText="暂无售后订单"}},loadMore(){this.hasMore&&!this.loading&&this.loadOrders()},cancelOrder(e){uni.showModal({title:"提示",content:"确定要取消该订单吗？",success:o=>{o.confirm&&(uni.showLoading({title:"取消中..."}),r.cancelOrder(e.orderNo).then((e=>{uni.hideLoading(),t("log","at pages/order/order.vue:379","取消订单响应:",e.data),200===e.data.code?(uni.showToast({title:"订单已取消",icon:"success"}),setTimeout((()=>{this.refreshOrders()}),1e3)):uni.showToast({title:e.data.message||"取消订单失败",icon:"none"})})).catch((e=>{uni.hideLoading(),t("error","at pages/order/order.vue:399","网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})))}})},goToOrderDetail(e){uni.navigateTo({url:`/pages/order/detail?orderNo=${e}`})},formatDate(e){if(!e)return"";const t=e.split(" ");if(t.length>=1){return`${t[0]} ${(t.length>1?t[1]:"").substring(0,5)}`}return e},getTotalQuantity:e=>e.orderDetails&&e.orderDetails.length?e.orderDetails.reduce(((e,t)=>e+t.quantity),0):0,touchStart(e,t){this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.direction="",this.isMoving=!1,this.activeIndex=t,this.orders.forEach(((e,o)=>{o!==t&&e.offset&&this.$set(e,"offset",0)}))},touchMove(e,t){if(this.activeIndex!==t)return;const o=e.touches[0].clientX,a=e.touches[0].clientY,s=o-this.touchStartX,n=a-this.touchStartY;if(!this.direction){if(!(Math.abs(s)>Math.abs(n)&&Math.abs(s)>5))return void(this.direction="vertical");this.direction="horizontal"}if("horizontal"===this.direction){this.isMoving=!0;let o=s;s>0&&!(this.orders[t].offset<0)&&(o=0);const a=1===this.orders[t].status?-(this.deleteButtonWidth+this.refundButtonWidth+2):-(this.deleteButtonWidth+2);o<a&&(o=a),this.$set(this.orders[t],"offset",o),e.preventDefault()}},touchEnd(e,t){if(this.activeIndex!==t||!this.isMoving)return;const o=this.orders[t],a=o.offset||0,s=1===o.status?-(this.deleteButtonWidth+this.refundButtonWidth+2):-(this.deleteButtonWidth+2);a<-20?this.$set(o,"offset",s):this.$set(o,"offset",0),this.isMoving=!1},closeAllSwipe(){this.orders&&this.orders.forEach(((e,t)=>{e.offset&&this.$set(e,"offset",0)}))},deleteOrder(e){uni.showModal({title:"提示",content:"确定要删除该订单吗？",success:o=>{o.confirm&&(uni.showLoading({title:"删除中..."}),r.deleteOrder(e).then((e=>{t("log","at pages/order/order.vue:560","删除订单响应:",e.data),200===e.data.code?(uni.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>{this.refreshOrders()}),1e3)):uni.showToast({title:e.data.message||"删除订单失败",icon:"none"})})).catch((e=>{t("error","at pages/order/order.vue:579","网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})).finally((()=>{uni.hideLoading()})))}})},applyRefund(e){uni.showModal({title:"申请退款",content:"确定要申请退款吗？",success:t=>{t.confirm&&uni.navigateTo({url:`/pages/order/refund?orderNo=${e.orderNo}&amount=${e.paymentAmount}`})}})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"order-container"},[e.createElementVNode("view",{class:"tabs"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.tabs,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["tab-item",n.activeTab===o?"active":""]),onClick:e=>r.switchTab(o)},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))]),e.createElementVNode("scroll-view",{class:"order-list","scroll-y":"true",onScrolltolower:o[1]||(o[1]=(...e)=>r.loadMore&&r.loadMore(...e)),"refresher-enabled":"","refresher-triggered":n.refreshing,onRefresherrefresh:o[2]||(o[2]=(...e)=>r.onRefresh&&r.onRefresh(...e)),onClick:o[3]||(o[3]=(...e)=>r.closeAllSwipe&&r.closeAllSwipe(...e))},[n.loading&&!n.refreshing&&0===n.orders.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-box"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"加载中...")])):e.createCommentVNode("",!0),0!==n.orders.length||n.loading?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-state"},[e.createElementVNode("image",{src:"/static/tabbar/order.png",class:"empty-icon"}),e.createElementVNode("text",{class:"empty-text"},e.toDisplayString(n.emptyText),1)])),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.orders,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"order-item-wrapper",key:a,onTouchstart:e=>r.touchStart(e,a),onTouchmove:e=>r.touchMove(e,a),onTouchend:e=>r.touchEnd(e,a)},[e.createElementVNode("view",{class:"action-buttons"},[1===t.status?(e.openBlock(),e.createElementBlock("view",{key:0,class:"refund-button",onClick:e.withModifiers((e=>r.applyRefund(t)),["stop"])},"申请退款",8,["onClick"])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"delete-button",onClick:e.withModifiers((e=>r.deleteOrder(t.orderNo)),["stop"])},"删除",8,["onClick"])]),e.createElementVNode("view",{class:"order-item-container",style:e.normalizeStyle({transform:`translateX(${t.offset||0}px)`}),onClick:e=>r.goToOrderDetail(t.orderNo)},[e.createElementVNode("view",{class:"order-item"},[e.createElementVNode("view",{class:"order-header"},[e.createElementVNode("view",{class:"order-number"},"订单号: "+e.toDisplayString(t.orderNo),1),e.createElementVNode("view",{class:"order-status"},e.toDisplayString(t.statusText),1)]),e.createElementVNode("view",{class:"order-products"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.orderDetails,((t,o)=>(e.openBlock(),e.createElementBlock("view",{class:"product-item",key:o},[e.createElementVNode("image",{class:"product-image",src:t.productImage,mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"product-info"},[e.createElementVNode("view",{class:"product-name"},e.toDisplayString(t.productName),1),t.temperature||t.sweetness?(e.openBlock(),e.createElementBlock("view",{key:0,class:"product-spec"},[t.temperature?(e.openBlock(),e.createElementBlock("text",{key:0},e.toDisplayString(t.temperature),1)):e.createCommentVNode("",!0),t.temperature&&t.sweetness?(e.openBlock(),e.createElementBlock("text",{key:1}," / ")):e.createCommentVNode("",!0),t.sweetness?(e.openBlock(),e.createElementBlock("text",{key:2},e.toDisplayString(t.sweetness),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),t.ingredients&&t.ingredients.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"product-ingredients"},[e.createTextVNode(" 配料: "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.ingredients,((o,a)=>(e.openBlock(),e.createElementBlock("text",{key:a},e.toDisplayString(o.name)+e.toDisplayString(a<t.ingredients.length-1?"、":""),1)))),128))])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"product-price-qty"},[e.createElementVNode("view",{class:"product-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1),e.createElementVNode("view",{class:"product-qty"},"x"+e.toDisplayString(t.quantity),1)])])))),128))]),e.createElementVNode("view",{class:"order-footer"},[e.createElementVNode("view",{class:"order-total"},[e.createElementVNode("text",null,"共"+e.toDisplayString(r.getTotalQuantity(t))+"件商品",1),e.createElementVNode("text",{class:"order-amount"},"实付: ¥"+e.toDisplayString(t.paymentAmount.toFixed(2)),1)]),e.createElementVNode("view",{class:"order-time"},e.toDisplayString(r.formatDate(t.createdAt)),1),e.createElementVNode("view",{class:"order-actions",onClick:o[0]||(o[0]=e.withModifiers((()=>{}),["stop"]))},[0===t.status?(e.openBlock(),e.createElementBlock("button",{key:0,class:"action-btn cancel-btn",onClick:e.withModifiers((e=>r.cancelOrder(t)),["stop"])},"取消订单",8,["onClick"])):e.createCommentVNode("",!0),0===t.status?(e.openBlock(),e.createElementBlock("button",{key:1,class:"action-btn pay-btn",onClick:e.withModifiers((e=>r.goToOrderDetail(t.orderNo)),["stop"])},"去支付",8,["onClick"])):e.createCommentVNode("",!0),e.createElementVNode("button",{class:"action-btn detail-btn",onClick:e.withModifiers((e=>r.goToOrderDetail(t.orderNo)),["stop"])},"订单详情",8,["onClick"])])])])],12,["onClick"])],40,["onTouchstart","onTouchmove","onTouchend"])))),128)),n.orders.length>0&&n.hasMore&&!n.loading?(e.openBlock(),e.createElementBlock("view",{key:2,class:"load-more"},[e.createElementVNode("text",null,"上拉加载更多")])):n.orders.length>0&&!n.hasMore?(e.openBlock(),e.createElementBlock("view",{key:3,class:"load-more"},[e.createElementVNode("text",null,"已加载全部")])):e.createCommentVNode("",!0),n.loading&&n.orders.length>0?(e.openBlock(),e.createElementBlock("view",{key:4,class:"loading-box"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"加载中...")])):e.createCommentVNode("",!0)],40,["refresher-triggered"])])}]]),y="/static/icons/common/right.svg";const k=i({data:()=>({isLoggedIn:!1,userInfo:{},memberInfo:{currentLevel:0,levelName:"普通会员",currentPoints:0,nextLevelPoints:1e3,pointsToNextLevel:1e3,discount:1,benefits:"无折扣"}}),onShow(){this.checkLoginStatus(),this.isLoggedIn&&(this.loadUserInfo(),this.loadMemberInfo())},methods:{checkLoginStatus(){const e=uni.getStorageSync("token");this.isLoggedIn=!!e},loadUserInfo(){this.isLoggedIn?r.request({url:"/user/profile",method:"GET"}).then((e=>{t("log","at pages/mine/mine.vue:115","用户信息响应:",e.data),200===e.data.code?this.userInfo=e.data.data:401===e.data.code||403===e.data.code?(t("log","at pages/mine/mine.vue:120","Token无效或权限不足，清除登录状态"),this.handleLogout()):this.showToast(e.data.message||"获取用户信息失败")})).catch((e=>{t("error","at pages/mine/mine.vue:127","请求失败:",e),this.showToast("网络请求失败")})):t("log","at pages/mine/mine.vue:106","未登录，跳过加载用户信息")},loadMemberInfo(){this.isLoggedIn?r.request({url:"/user/member-level",method:"GET"}).then((e=>{t("log","at pages/mine/mine.vue:144","会员信息响应:",e.data),200===e.data.code?this.memberInfo=e.data.data:401!==e.data.code&&403!==e.data.code||t("log","at pages/mine/mine.vue:149","Token无效或权限不足，使用默认会员信息")})).catch((e=>{t("error","at pages/mine/mine.vue:153","获取会员信息失败:",e)})):t("log","at pages/mine/mine.vue:135","未登录，跳过加载会员信息")},calcProgressPercent(){if(!this.memberInfo||!this.memberInfo.nextLevelPoints||0===this.memberInfo.nextLevelPoints)return 0;const e=this.memberInfo.nextLevelPoints-this.memberInfo.pointsToNextLevel;return Math.min(100,Math.floor(e/this.memberInfo.nextLevelPoints*100))},previewAvatar(){const e=this.userInfo.avatar||"/static/tabbar/user.png";uni.navigateTo({url:`/pages/user/avatar-view?url=${encodeURIComponent(e)}`})},viewMemberDetail(){this.isLoggedIn?uni.navigateTo({url:"/pages/user/member-center"}):this.promptLogin()},goToOrderHistory(){this.isLoggedIn?uni.switchTab({url:"/pages/order/order"}):this.promptLogin()},goToSettings(){uni.navigateTo({url:"/pages/user/settings"})},contactUs(){this.showToast("联系客服页面开发中")},aboutUs(){this.showToast("关于我们页面开发中")},goToLogin(){uni.navigateTo({url:"/pages/login/login"})},logout(){uni.showModal({title:"提示",content:"确定要退出登录吗？",success:e=>{e.confirm&&this.handleLogout()}})},handleLogout(){uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),this.isLoggedIn=!1,this.userInfo={},this.showToast("已退出登录","success")},promptLogin(){uni.showModal({title:"提示",content:"请先登录",confirmText:"去登录",success:e=>{e.confirm&&this.goToLogin()}})},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"mine-container"},[e.createElementVNode("view",{class:"user-card"},[n.isLoggedIn?(e.openBlock(),e.createElementBlock("view",{key:0,class:"user-info"},[e.createElementVNode("image",{class:"avatar",src:n.userInfo.avatar||"/static/tabbar/user.png",onClick:o[0]||(o[0]=(...e)=>r.previewAvatar&&r.previewAvatar(...e))},null,8,["src"]),e.createElementVNode("view",{class:"user-detail"},[e.createElementVNode("view",{class:"username"},e.toDisplayString(n.userInfo.username),1),e.createElementVNode("view",{class:"member-info"},[e.createElementVNode("text",{class:"member-level"},e.toDisplayString(n.memberInfo.levelName),1),e.createElementVNode("text",{class:"member-points"},"积分: "+e.toDisplayString(n.userInfo.totalPoints||0),1)])])])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"not-login"},[e.createElementVNode("image",{class:"default-avatar",src:"/static/tabbar/user.png"}),e.createElementVNode("view",{class:"login-btn"},[e.createElementVNode("button",{type:"primary",size:"mini",onClick:o[1]||(o[1]=(...e)=>r.goToLogin&&r.goToLogin(...e))},"立即登录")])]))]),n.isLoggedIn?(e.openBlock(),e.createElementBlock("view",{key:0,class:"member-card",onClick:o[2]||(o[2]=(...e)=>r.viewMemberDetail&&r.viewMemberDetail(...e))},[e.createElementVNode("view",{class:"member-card-header"},[e.createElementVNode("text",{class:"card-title"},"会员卡"),e.createElementVNode("text",{class:"card-subtitle"},"查看详情")]),e.createElementVNode("view",{class:"member-progress"},[e.createElementVNode("view",{class:"progress-text"},[e.createElementVNode("text",null,e.toDisplayString(n.memberInfo.levelName),1),e.createElementVNode("text",null,"下一级: 还需"+e.toDisplayString(n.memberInfo.pointsToNextLevel)+"积分",1)]),e.createElementVNode("progress",{percent:r.calcProgressPercent(),"stroke-width":"4",activeColor:"#7b68ee",backgroundColor:"#333"},null,8,["percent"])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"menu-list"},[e.createElementVNode("view",{class:"menu-section"},[e.createElementVNode("view",{class:"menu-item",onClick:o[3]||(o[3]=(...e)=>r.goToOrderHistory&&r.goToOrderHistory(...e))},[e.createElementVNode("image",{src:"/static/icons/common/order.svg",class:"menu-icon-img"}),e.createElementVNode("text",{class:"menu-text"},"我的订单"),e.createElementVNode("image",{src:y,class:"arrow-img"})])]),e.createElementVNode("view",{class:"menu-section"},[e.createElementVNode("view",{class:"menu-item",onClick:o[4]||(o[4]=(...e)=>r.goToSettings&&r.goToSettings(...e))},[e.createElementVNode("image",{src:"/static/icons/common/settings.svg",class:"menu-icon-img"}),e.createElementVNode("text",{class:"menu-text"},"设置"),e.createElementVNode("image",{src:y,class:"arrow-img"})]),e.createElementVNode("view",{class:"menu-item",onClick:o[5]||(o[5]=(...e)=>r.contactUs&&r.contactUs(...e))},[e.createElementVNode("image",{src:"/static/icons/common/service.svg",class:"menu-icon-img"}),e.createElementVNode("text",{class:"menu-text"},"联系客服"),e.createElementVNode("image",{src:y,class:"arrow-img"})]),e.createElementVNode("view",{class:"menu-item",onClick:o[6]||(o[6]=(...e)=>r.aboutUs&&r.aboutUs(...e))},[e.createElementVNode("image",{src:"/static/icons/common/about.svg",class:"menu-icon-img"}),e.createElementVNode("text",{class:"menu-text"},"关于我们"),e.createElementVNode("image",{src:y,class:"arrow-img"})])])])])}]]);const N=i({data:()=>({username:"",password:"",shopLogo:"",agreedToTerms:!1}),onLoad(){this.getShopInfo()},methods:{toggleAgreement(){this.agreedToTerms=!this.agreedToTerms},getShopInfo(){r.getShopInfo().then((e=>{200===e.data.code&&e.data.data&&(this.shopLogo=e.data.data.logo)})).catch((e=>{t("error","at pages/login/login.vue:114","获取店铺信息失败",e)}))},handleLogin(){this.agreedToTerms?this.username?this.password?(uni.showLoading({title:"登录中..."}),r.login(this.username,this.password).then((e=>{if(uni.hideLoading(),200===e.data.code){const t=e.data.data.token,o=e.data.data.user;uni.setStorageSync("token",t),uni.setStorageSync("userInfo",o),uni.showToast({title:"登录成功",icon:"success",duration:1500,success:()=>{uni.switchTab({url:"/pages/index/index"})}})}else uni.showToast({title:e.data.message||"登录失败，请检查账号密码",icon:"none"})})).catch((e=>{uni.hideLoading(),uni.showToast({title:"网络异常，请稍后重试",icon:"none"}),t("error","at pages/login/login.vue:184","登录请求失败",e)}))):uni.showToast({title:"请输入密码",icon:"none"}):uni.showToast({title:"请输入用户名或手机号",icon:"none"}):uni.showToast({title:"请先阅读并同意协议",icon:"none"})},forgotPassword(){uni.showToast({title:"功能开发中",icon:"none"})},goToRegister(){uni.navigateTo({url:"/pages/register/register"})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"login-container"},[e.createElementVNode("view",{class:"floating-bubbles"},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(8,(t=>e.createElementVNode("view",{class:"bubble",key:t,style:e.normalizeStyle("--size:"+(30+60*Math.random())+"rpx; --delay:"+5*Math.random()+"s; --duration:"+(10+20*Math.random())+"s")},null,4))),64))]),e.createElementVNode("view",{class:"decoration-cup left-cup"}),e.createElementVNode("view",{class:"decoration-cup right-cup"}),e.createElementVNode("view",{class:"login-content"},[e.createElementVNode("view",{class:"login-header"},[e.createElementVNode("view",{class:"logo-container"},[e.createElementVNode("image",{class:"logo",src:n.shopLogo||"/static/logo.png",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"logo-backdrop"}),e.createElementVNode("view",{class:"logo-ring"})]),e.createElementVNode("view",{class:"title-group"},[e.createElementVNode("text",{class:"title"},"奶茶物语"),e.createElementVNode("text",{class:"subtitle"},"Milk Tea Story")])]),e.createElementVNode("view",{class:"login-form glass-card"},[e.createElementVNode("view",{class:"form-heading"},[e.createElementVNode("text",{class:"heading-text"},"欢迎回来"),e.createElementVNode("view",{class:"heading-line"})]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"账号"),e.createElementVNode("view",{class:"input-wrapper"},[e.createElementVNode("view",{class:"input-icon"},[e.createElementVNode("view",{class:"user-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"input-box",type:"text",placeholder:"用户名或手机号","onUpdate:modelValue":o[0]||(o[0]=e=>n.username=e)},null,512),[[e.vModelText,n.username]])])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"密码"),e.createElementVNode("view",{class:"input-wrapper"},[e.createElementVNode("view",{class:"input-icon"},[e.createElementVNode("view",{class:"lock-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"input-box",type:"password",placeholder:"请输入密码","onUpdate:modelValue":o[1]||(o[1]=e=>n.password=e)},null,512),[[e.vModelText,n.password]])])]),e.createElementVNode("view",{class:"agreement-row"},[e.createElementVNode("view",{class:"checkbox-container",onClick:o[2]||(o[2]=(...e)=>r.toggleAgreement&&r.toggleAgreement(...e))},[e.createElementVNode("view",{class:e.normalizeClass(["checkbox",{checked:n.agreedToTerms}])},[n.agreedToTerms?(e.openBlock(),e.createElementBlock("text",{key:0,class:"checkbox-inner"},"✓")):e.createCommentVNode("",!0)],2)]),e.createElementVNode("view",{class:"agreement-text"},[e.createElementVNode("text",null,"我已阅读并同意"),e.createElementVNode("text",{class:"agreement-link"},"《用户协议》"),e.createElementVNode("text",null,"和"),e.createElementVNode("text",{class:"agreement-link"},"《隐私政策》")])]),e.createElementVNode("button",{class:e.normalizeClass(["login-btn",{"login-btn-disabled":!n.agreedToTerms}]),disabled:!n.agreedToTerms,onClick:o[3]||(o[3]=(...e)=>r.handleLogin&&r.handleLogin(...e))},[e.createElementVNode("text",{class:"btn-text"},"登录"),e.createElementVNode("view",{class:"btn-arrow"},"→")],10,["disabled"]),e.createElementVNode("view",{class:"action-links"},[e.createElementVNode("text",{class:"forgot-pwd",onClick:o[4]||(o[4]=(...e)=>r.forgotPassword&&r.forgotPassword(...e))},"忘记密码?"),e.createElementVNode("text",{class:"register",onClick:o[5]||(o[5]=(...e)=>r.goToRegister&&r.goToRegister(...e))},"立即注册")])]),e.createElementVNode("view",{class:"slogan"},"用心调制，每一杯都是独特体验")])])}]]);const V=i({data:()=>({formData:{username:"",password:"",confirmPassword:"",agreed:!1},shopLogo:""}),onLoad(){this.getShopInfo()},methods:{getShopInfo(){r.getShopInfo().then((e=>{200===e.data.code&&e.data.data&&(this.shopLogo=e.data.data.logo)})).catch((e=>{t("error","at pages/register/register.vue:121","获取店铺信息失败",e)}))},handleRegister(){this.formData.username?this.formData.phone?/^1\d{10}$/.test(this.formData.phone)?this.formData.password?this.formData.password.length<6||this.formData.password.length>20?uni.showToast({title:"密码长度应为6-20位",icon:"none"}):this.formData.password===this.formData.confirmPassword?this.formData.agreed?(uni.showLoading({title:"注册中..."}),uni.request({url:`${this.baseUrl}/user/register`,method:"POST",data:{username:this.formData.username,password:this.formData.password,phone:this.formData.phone},success:e=>{uni.hideLoading(),200===e.data.code?uni.showToast({title:"注册成功",icon:"success",duration:1500,success:()=>{setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)}}):uni.showToast({title:e.data.message||"注册失败，请稍后重试",icon:"none"})},fail:e=>{uni.hideLoading(),uni.showToast({title:"网络异常，请稍后重试",icon:"none"}),t("error","at pages/register/register.vue:221","注册请求失败",e)}})):uni.showToast({title:"请阅读并同意用户协议与隐私政策",icon:"none"}):uni.showToast({title:"两次密码输入不一致",icon:"none"}):uni.showToast({title:"请设置密码",icon:"none"}):uni.showToast({title:"手机号格式不正确",icon:"none"}):uni.showToast({title:"请输入手机号",icon:"none"}):uni.showToast({title:"请输入用户名",icon:"none"})},goToLogin(){uni.navigateTo({url:"/pages/login/login"})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"register-container"},[e.createElementVNode("view",{class:"floating-bubbles"},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(8,(t=>e.createElementVNode("view",{class:"bubble",key:t,style:e.normalizeStyle("--size:"+(30+60*Math.random())+"rpx; --delay:"+5*Math.random()+"s; --duration:"+(10+20*Math.random())+"s")},null,4))),64))]),e.createElementVNode("view",{class:"decoration-cup left-cup"}),e.createElementVNode("view",{class:"decoration-cup right-cup"}),e.createElementVNode("view",{class:"register-content"},[e.createElementVNode("view",{class:"register-header"},[e.createElementVNode("view",{class:"logo-container"},[e.createElementVNode("image",{class:"logo",src:n.shopLogo||"/static/logo.png",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"logo-backdrop"}),e.createElementVNode("view",{class:"logo-ring"})]),e.createElementVNode("view",{class:"title-group"},[e.createElementVNode("text",{class:"title"},"注册会员"),e.createElementVNode("text",{class:"subtitle"},"加入奶茶物语")])]),e.createElementVNode("view",{class:"register-form glass-card"},[e.createElementVNode("view",{class:"form-heading"},[e.createElementVNode("text",{class:"heading-text"},"创建账号"),e.createElementVNode("view",{class:"heading-line"})]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"用户名"),e.createElementVNode("view",{class:"input-wrapper"},[e.createElementVNode("view",{class:"input-icon"},[e.createElementVNode("view",{class:"user-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"input-box",type:"text",placeholder:"请输入用户名","onUpdate:modelValue":o[0]||(o[0]=e=>n.formData.username=e)},null,512),[[e.vModelText,n.formData.username]])])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"手机号"),e.createElementVNode("view",{class:"input-wrapper"},[e.createElementVNode("view",{class:"input-icon"},[e.createElementVNode("view",{class:"phone-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"input-box",type:"number",placeholder:"请输入手机号",maxlength:"11","onUpdate:modelValue":o[1]||(o[1]=e=>n.formData.phone=e)},null,512),[[e.vModelText,n.formData.phone]])])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"设置密码"),e.createElementVNode("view",{class:"input-wrapper"},[e.createElementVNode("view",{class:"input-icon"},[e.createElementVNode("view",{class:"lock-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"input-box",type:"password",placeholder:"请设置6-20位密码","onUpdate:modelValue":o[2]||(o[2]=e=>n.formData.password=e)},null,512),[[e.vModelText,n.formData.password]])])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"确认密码"),e.createElementVNode("view",{class:"input-wrapper"},[e.createElementVNode("view",{class:"input-icon"},[e.createElementVNode("view",{class:"lock-icon"})]),e.withDirectives(e.createElementVNode("input",{class:"input-box",type:"password",placeholder:"请再次输入密码","onUpdate:modelValue":o[3]||(o[3]=e=>n.formData.confirmPassword=e)},null,512),[[e.vModelText,n.formData.confirmPassword]])])]),e.createElementVNode("view",{class:"agreement"},[e.createElementVNode("view",{class:"custom-checkbox",onClick:o[4]||(o[4]=e=>n.formData.agreed=!n.formData.agreed)},[e.createElementVNode("view",{class:e.normalizeClass(["checkbox-inner",{checked:n.formData.agreed}])},null,2)]),e.createElementVNode("text",{class:"agreement-text"},[e.createTextVNode("我已阅读并同意"),e.createElementVNode("text",{class:"link"},"《用户协议》"),e.createTextVNode("和"),e.createElementVNode("text",{class:"link"},"《隐私政策》")])]),e.createElementVNode("button",{class:"register-btn",onClick:o[5]||(o[5]=(...e)=>r.handleRegister&&r.handleRegister(...e)),disabled:!n.formData.agreed},[e.createElementVNode("text",{class:"btn-text"},"注册"),e.createElementVNode("view",{class:"btn-arrow"},"→")],8,["disabled"]),e.createElementVNode("view",{class:"action-links"},[e.createElementVNode("text",{class:"login-link",onClick:o[6]||(o[6]=(...e)=>r.goToLogin&&r.goToLogin(...e))},"已有账号，去登录")])])])])}]]),f="/static/icons/common/back.svg";const T=i({data:()=>({avatarUrl:"",isVirtualKeyboardShowing:!1,imageLoadError:!1}),onLoad(e){e.url?this.avatarUrl=decodeURIComponent(e.url):this.loadUserAvatar()},methods:{goBack(){uni.navigateBack()},loadUserAvatar(){if(!uni.getStorageSync("token"))return this.showToast("请先登录"),void setTimeout((()=>{uni.navigateBack()}),1500);r.request({url:"/user/profile",method:"GET",success:e=>{t("log","at pages/user/avatar-view.vue:70","获取用户信息响应:",e.data),200===e.data.code?this.avatarUrl=r.processImageUrl(e.data.data.avatar||""):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"获取用户信息失败")},fail:e=>{t("error","at pages/user/avatar-view.vue:82","网络请求失败:",e),this.showToast("网络请求失败")}})},handleImageError(){this.imageLoadError||(this.imageLoadError=!0,this.showToast("图片加载失败，使用默认头像"),this.avatarUrl="/static/default-avatar.png")},uploadAvatar(){uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{const o=e.tempFilePaths,a=uni.getStorageSync("token");uni.showLoading({title:"上传中..."});const s=r.getBaseUrl();uni.uploadFile({url:`${s}/files/avatar`,filePath:o[0],name:"file",header:{Authorization:"Bearer "+a},success:e=>{t("log","at pages/user/avatar-view.vue:121","头像上传响应:",e);try{const t=JSON.parse(e.data);if(200===t.code){this.avatarUrl=r.processImageUrl(t.data.url),this.showToast("头像上传成功","success");const e=uni.getStorageSync("userInfo")||{};e.avatar=t.data.url,uni.setStorageSync("userInfo",e)}else this.showToast(t.message||"上传失败")}catch(o){t("error","at pages/user/avatar-view.vue:137","解析响应失败:",o),this.showToast("响应解析失败")}},fail:e=>{t("error","at pages/user/avatar-view.vue:142","上传失败:",e),this.showToast("上传失败，请检查网络")},complete:()=>{uni.hideLoading()}})}})},handleTokenExpired(){uni.showToast({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"avatar-view-container"},[e.createElementVNode("view",{class:"custom-navbar"},[e.createElementVNode("view",{class:"navbar-left",onClick:o[0]||(o[0]=(...e)=>r.goBack&&r.goBack(...e))},[e.createElementVNode("image",{src:f,class:"back-icon"})]),e.createElementVNode("view",{class:"navbar-title"},"头像"),e.createElementVNode("view",{class:"navbar-right"})]),e.createElementVNode("view",{class:"avatar-display"},[e.createElementVNode("image",{src:n.avatarUrl||"/static/default-avatar.png",mode:"aspectFill",class:"avatar-image",onError:o[1]||(o[1]=(...e)=>r.handleImageError&&r.handleImageError(...e))},null,40,["src"])]),e.createElementVNode("view",{class:"action-buttons"},[e.createElementVNode("button",{class:"action-btn upload-btn",onClick:o[2]||(o[2]=(...e)=>r.uploadAvatar&&r.uploadAvatar(...e))},"更换头像")])])}]]);const x=i({data:()=>({loading:!0,orderNo:"",orderDetail:{},showPaymentPopup:!1,paymentMethod:"wechat",scrollTop:0}),computed:{orderStatusText(){switch(this.orderDetail.status){case 0:return"待支付";case 1:return"已支付";case 2:return"已完成";case 3:return"退款中";case 4:return"已退款";case 5:return"已取消";case 6:return"拒绝退款";default:return"未知状态"}}},onLoad(e){e.orderNo?(this.orderNo=e.orderNo,this.loadOrderDetail()):(uni.showToast({title:"订单号不存在",icon:"none"}),setTimeout((()=>{this.goBack()}),1500))},methods:{onScroll(e){},goBack(){!this.orderDetail||0!==this.orderDetail.status&&5!==this.orderDetail.status?(t("log","at pages/order/detail.vue:279","订单状态:",this.orderDetail.status,"返回上一页"),uni.navigateBack()):(t("log","at pages/order/detail.vue:273","订单状态:",this.orderDetail.status,"跳转到订单列表页"),uni.switchTab({url:"/pages/order/order"}))},loadOrderDetail(){this.loading=!0,r.getOrderDetail(this.orderNo).then((e=>{if(t("log","at pages/order/detail.vue:290","订单详情响应:",e.data),200===e.data.code){let o=e.data.data;void 0===o.couponAmount&&(o.totalAmount&&o.paymentAmount?o.couponAmount=o.totalAmount-o.paymentAmount:o.couponAmount=0),this.orderDetail=o,t("log","at pages/order/detail.vue:305","处理后的订单数据:",this.orderDetail)}else uni.showToast({title:e.data.message||"获取订单详情失败",icon:"none"})})).catch((e=>{t("error","at pages/order/detail.vue:314","网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})).finally((()=>{this.loading=!1}))},formatDate(e){if(!e)return"";const t=e.split(" ");if(t.length>=1){return`${t[0]} ${(t.length>1?t[1]:"").substring(0,5)}`}return e},getPaymentMethodText(e){switch(e){case"wechat":return"微信支付";case"alipay":return"支付宝";default:return e||"未知方式"}},cancelOrder(){uni.showModal({title:"提示",content:"确定要取消该订单吗？",success:e=>{e.confirm&&(uni.showLoading({title:"取消中..."}),r.cancelOrder(this.orderNo).then((e=>{t("log","at pages/order/detail.vue:366","取消订单响应:",e.data),200===e.data.code?(uni.showToast({title:"订单已取消",icon:"success"}),setTimeout((()=>{this.orderDetail&&(this.orderDetail.status=5),uni.switchTab({url:"/pages/order/order"})}),1500)):uni.showToast({title:e.data.message||"取消订单失败",icon:"none"})})).catch((e=>{t("error","at pages/order/detail.vue:391","网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})).finally((()=>{uni.hideLoading()})))}})},payOrder(){this.showPaymentPopup=!0,this.paymentMethod="wechat"},closePopup(){this.showPaymentPopup=!1},confirmPayment(){uni.showLoading({title:"支付中..."});const e=this.paymentMethod;t("log","at pages/order/detail.vue:425","[确认支付] 准备支付订单:",this.orderNo),t("log","at pages/order/detail.vue:426","[确认支付] 选择的支付方式:",e),r.payOrder(this.orderNo,e).then((e=>{t("log","at pages/order/detail.vue:431","[API调用] 支付订单响应:",e.data),200===e.data.code?(uni.showToast({title:"支付成功",icon:"success"}),this.closePopup(),this.checkAndUpdateCart(),this.refreshCouponsAfterPayment(),setTimeout((()=>{uni.switchTab({url:"/pages/order/order"})}),1500)):uni.showToast({title:e.data.message||"支付失败",icon:"none"})})).catch((e=>{t("error","at pages/order/detail.vue:461","[API调用] 网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})).finally((()=>{uni.hideLoading()}))},refreshCouponsAfterPayment(){r.refreshCoupons().then((e=>{t("log","at pages/order/detail.vue:477","支付后刷新优惠券状态:",e.data)})).catch((e=>{t("error","at pages/order/detail.vue:481","刷新优惠券状态失败:",e)}))},checkAndUpdateCart(){r.getCart().then((e=>{t("log","at pages/order/detail.vue:490","获取购物车信息:",e.data);let o=!1;e.data&&200===e.data.code&&e.data.data&&e.data.data.items?o=e.data.data.items.some((e=>e.selected)):Array.isArray(e.data)?o=e.data.some((e=>e.selected)):e.data&&e.data.items&&(o=e.data.items.some((e=>e.selected))),o&&this.clearSelectedCartItems()})).catch((e=>{t("error","at pages/order/detail.vue:510","获取购物车信息失败:",e)}))},clearSelectedCartItems(){r.clearSelectedCartItems().then((e=>{t("log","at pages/order/detail.vue:518","移除已选择的购物车商品成功:",e.data)})).catch((e=>{t("error","at pages/order/detail.vue:521","移除购物车商品失败:",e)}))},selectPaymentMethod(e){this.paymentMethod=e}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"detail-container"},[e.createElementVNode("view",{class:"navbar"},[e.createElementVNode("view",{class:"back-btn",onClick:o[0]||(o[0]=(...e)=>r.goBack&&r.goBack(...e))},[e.createElementVNode("image",{src:f,class:"back-icon"})]),e.createElementVNode("view",{class:"title"},"订单详情"),e.createElementVNode("view",{class:"navbar-right"})]),n.loading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-box"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"加载中...")])):(e.openBlock(),e.createElementBlock("scroll-view",{key:1,"scroll-y":"","scroll-top":n.scrollTop,class:"detail-scroll-view","enable-back-to-top":"",enhanced:!0,bounces:!0,"show-scrollbar":!0,onScroll:o[3]||(o[3]=(...e)=>r.onScroll&&r.onScroll(...e))},[e.createElementVNode("view",{class:"status-card"},[e.createElementVNode("view",{class:"status-header"},[e.createElementVNode("text",{class:"status-text"},e.toDisplayString(r.orderStatusText),1),e.createElementVNode("text",{class:"order-id"},"订单号: "+e.toDisplayString(n.orderDetail.orderNo),1)]),5!==n.orderDetail.status?(e.openBlock(),e.createElementBlock("view",{key:0,class:"status-timeline"},[e.createElementVNode("view",{class:e.normalizeClass(["timeline-item",{completed:n.orderDetail.status>=0}])},[e.createElementVNode("view",{class:"timeline-dot"}),e.createElementVNode("view",{class:"timeline-info"},[e.createElementVNode("text",{class:"timeline-title"},"订单已提交"),n.orderDetail.createdAt?(e.openBlock(),e.createElementBlock("text",{key:0,class:"timeline-time"},e.toDisplayString(r.formatDate(n.orderDetail.createdAt)),1)):e.createCommentVNode("",!0)])],2),e.createElementVNode("view",{class:e.normalizeClass(["timeline-line",{completed:n.orderDetail.status>=1}])},null,2),e.createElementVNode("view",{class:e.normalizeClass(["timeline-item",{completed:n.orderDetail.status>=1}])},[e.createElementVNode("view",{class:"timeline-dot"}),e.createElementVNode("view",{class:"timeline-info"},[e.createElementVNode("text",{class:"timeline-title"},"支付成功"),n.orderDetail.paymentTime?(e.openBlock(),e.createElementBlock("text",{key:0,class:"timeline-time"},e.toDisplayString(r.formatDate(n.orderDetail.paymentTime)),1)):e.createCommentVNode("",!0),n.orderDetail.takeNo?(e.openBlock(),e.createElementBlock("text",{key:1,class:"timeline-time"},"取餐号: "+e.toDisplayString(n.orderDetail.takeNo),1)):e.createCommentVNode("",!0)])],2)])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"status-canceled"},[e.createElementVNode("text",{class:"canceled-text"},"订单已取消"),n.orderDetail.cancelTime?(e.openBlock(),e.createElementBlock("text",{key:0,class:"canceled-time"},e.toDisplayString(r.formatDate(n.orderDetail.cancelTime)),1)):e.createCommentVNode("",!0),n.orderDetail.refundInfo?(e.openBlock(),e.createElementBlock("view",{key:1,class:"refund-info"},[e.createElementVNode("text",{class:"refund-reason"},"退款原因: "+e.toDisplayString(n.orderDetail.refundInfo.reason||"无"),1),n.orderDetail.refundInfo.refundTime?(e.openBlock(),e.createElementBlock("text",{key:0,class:"refund-time"},"退款时间: "+e.toDisplayString(r.formatDate(n.orderDetail.refundInfo.refundTime)),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)]))]),1===n.orderDetail.status?(e.openBlock(),e.createElementBlock("view",{key:0,class:"detail-section"},[e.createElementVNode("view",{class:"section-title"},"取餐信息"),e.createElementVNode("view",{class:"pickup-info"},[e.createElementVNode("view",{class:"pickup-item"},[e.createElementVNode("text",{class:"pickup-value"},e.toDisplayString(n.orderDetail.takeNo),1)]),e.createElementVNode("view",{class:"pickup-note"},[e.createElementVNode("text",null,"请凭取餐号到门店取餐")])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"detail-section"},[e.createElementVNode("view",{class:"section-title"},"商品信息"),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.orderDetail.orderDetails,((t,o)=>(e.openBlock(),e.createElementBlock("view",{class:"product-item",key:o},[e.createElementVNode("image",{class:"product-image",src:t.productImage,mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"product-info"},[e.createElementVNode("view",{class:"product-name"},e.toDisplayString(t.productName),1),t.temperature||t.sweetness?(e.openBlock(),e.createElementBlock("view",{key:0,class:"product-spec"},[t.temperature?(e.openBlock(),e.createElementBlock("text",{key:0},e.toDisplayString(t.temperature),1)):e.createCommentVNode("",!0),t.temperature&&t.sweetness?(e.openBlock(),e.createElementBlock("text",{key:1}," / ")):e.createCommentVNode("",!0),t.sweetness?(e.openBlock(),e.createElementBlock("text",{key:2},e.toDisplayString(t.sweetness),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),t.ingredients&&t.ingredients.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"product-ingredients"},[e.createTextVNode(" 配料: "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.ingredients,((o,a)=>(e.openBlock(),e.createElementBlock("text",{key:a},e.toDisplayString(o.name)+e.toDisplayString(a<t.ingredients.length-1?"、":""),1)))),128))])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"product-price-qty"},[e.createElementVNode("view",{class:"product-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1),e.createElementVNode("view",{class:"product-qty"},"x"+e.toDisplayString(t.quantity),1)])])))),128))]),e.createElementVNode("view",{class:"detail-section"},[e.createElementVNode("view",{class:"section-title"},"订单金额"),e.createElementVNode("view",{class:"price-list"},[e.createElementVNode("view",{class:"price-item"},[e.createElementVNode("text",{class:"price-label"},"商品总价"),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(n.orderDetail.totalAmount.toFixed(2)),1)]),n.orderDetail.couponAmount>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"price-item"},[e.createElementVNode("text",{class:"price-label"},"优惠金额"),e.createElementVNode("text",{class:"price-value discount"},"-¥"+e.toDisplayString(n.orderDetail.couponAmount.toFixed(2)),1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"price-item total"},[e.createElementVNode("text",{class:"price-label"},"实付金额"),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString((n.orderDetail.displayAmount||n.orderDetail.paymentAmount).toFixed(2)),1)])])]),n.orderDetail.status>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"detail-section"},[e.createElementVNode("view",{class:"section-title"},"支付信息"),e.createElementVNode("view",{class:"payment-info"},[e.createElementVNode("view",{class:"payment-item"},[e.createElementVNode("text",{class:"payment-label"},"支付方式"),e.createElementVNode("text",{class:"payment-value"},e.toDisplayString(r.getPaymentMethodText(n.orderDetail.paymentMethod)),1)]),n.orderDetail.paymentTime?(e.openBlock(),e.createElementBlock("view",{key:0,class:"payment-item"},[e.createElementVNode("text",{class:"payment-label"},"支付时间"),e.createElementVNode("text",{class:"payment-value"},e.toDisplayString(r.formatDate(n.orderDetail.paymentTime)),1)])):e.createCommentVNode("",!0),n.orderDetail.transactionId?(e.openBlock(),e.createElementBlock("view",{key:1,class:"payment-item"},[e.createElementVNode("text",{class:"payment-label"},"交易单号"),e.createElementVNode("text",{class:"payment-value"},e.toDisplayString(n.orderDetail.transactionId),1)])):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0),0===n.orderDetail.status?(e.openBlock(),e.createElementBlock("view",{key:2,class:"detail-actions"},[e.createElementVNode("button",{class:"action-btn cancel-btn",onClick:o[1]||(o[1]=(...e)=>r.cancelOrder&&r.cancelOrder(...e))},"取消订单"),e.createElementVNode("button",{class:"action-btn pay-btn",onClick:o[2]||(o[2]=(...e)=>r.payOrder&&r.payOrder(...e))},"去支付")])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"safe-area-inset-bottom"})],40,["scroll-top"])),n.showPaymentPopup?(e.openBlock(),e.createElementBlock("view",{key:2,class:"payment-popup"},[e.createElementVNode("view",{class:"popup-mask",onClick:o[4]||(o[4]=(...e)=>r.closePopup&&r.closePopup(...e))}),e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-header"},[e.createElementVNode("text",{class:"popup-title"},"订单支付"),e.createElementVNode("text",{class:"popup-close",onClick:o[5]||(o[5]=(...e)=>r.closePopup&&r.closePopup(...e))},"×")]),e.createElementVNode("view",{class:"popup-body"},[e.createElementVNode("view",{class:"payment-amount-info"},[e.createElementVNode("view",{class:"payment-amount"},"¥"+e.toDisplayString(n.orderDetail.paymentAmount.toFixed(2)),1),e.createElementVNode("view",{class:"payment-order-no"},"订单号: "+e.toDisplayString(n.orderDetail.orderNo||""),1)]),e.createElementVNode("view",{class:"payment-methods"},[e.createElementVNode("view",{class:e.normalizeClass(["payment-method-item",{active:"wechat"===n.paymentMethod}]),onClick:o[6]||(o[6]=e=>r.selectPaymentMethod("wechat"))},[e.createElementVNode("view",{class:"payment-method-content"},[e.createElementVNode("view",{class:"payment-icon payment-icon-wechat"},[e.createElementVNode("image",{src:"/static/icons/payment/wechat.svg",mode:"aspectFit",class:"payment-icon-img"})]),e.createElementVNode("text",{class:"payment-name"},"微信支付")]),"wechat"===n.paymentMethod?(e.openBlock(),e.createElementBlock("text",{key:0,class:"payment-select"},"✓")):e.createCommentVNode("",!0)],2),e.createElementVNode("view",{class:e.normalizeClass(["payment-method-item",{active:"alipay"===n.paymentMethod}]),onClick:o[7]||(o[7]=e=>r.selectPaymentMethod("alipay"))},[e.createElementVNode("view",{class:"payment-method-content"},[e.createElementVNode("view",{class:"payment-icon payment-icon-alipay"},[e.createElementVNode("image",{src:"/static/icons/payment/alipay.svg",mode:"aspectFit",class:"payment-icon-img"})]),e.createElementVNode("text",{class:"payment-name"},"支付宝")]),"alipay"===n.paymentMethod?(e.openBlock(),e.createElementBlock("text",{key:0,class:"payment-select"},"✓")):e.createCommentVNode("",!0)],2)])]),e.createElementVNode("view",{class:"popup-footer"},[e.createElementVNode("button",{class:"confirm-payment-btn",onClick:o[8]||(o[8]=(...e)=>r.confirmPayment&&r.confirmPayment(...e))},"确认支付")])])])):e.createCommentVNode("",!0)])}]]);const b=i({data:()=>({cartItems:[],loading:!0,availableCoupons:[],selectedCoupon:null,paymentMethod:"wechat",paymentMethods:[{name:"微信支付",value:"wechat",icon:"weixin"},{name:"支付宝",value:"alipay",icon:"zhifubao"},{name:"积分支付",value:"point",icon:"jifen"}],note:"",deliveryFee:0,showCouponModal:!1,memberInfo:null,memberDiscount:1}),onLoad(e){if(this.getMemberInfo(),e&&e.items)try{const t=JSON.parse(decodeURIComponent(e.items));t&&Array.isArray(t)&&t.length>0&&(this.cartItems=t,this.loading=!1)}catch(o){t("error","at pages/order/confirm.vue:215","解析传入商品数据失败:",o)}this.cartItems&&0!==this.cartItems.length||this.loadCartItems(),this.loadUserCoupons()},methods:{loadCartItems(){this.loading=!0,r.request({url:"/cart",method:"GET",success:e=>{if(this.loading=!1,200===e.statusCode){if(200===e.data.code&&e.data.data){const t=e.data.data;this.cartItems=t.items?t.items.filter((e=>e.selected)):[]}else Array.isArray(e.data)?this.cartItems=e.data.filter((e=>e.selected)):e.data.items&&Array.isArray(e.data.items)&&(this.cartItems=e.data.items.filter((e=>e.selected)));0===this.cartItems.length&&uni.showModal({title:"提示",content:"请先选择商品后再结算",showCancel:!1,success:()=>{uni.navigateBack()}})}else 401===e.statusCode||e.data&&401===e.data.code?(uni.removeStorageSync("token"),uni.showToast({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)):uni.showToast({title:e.data.message||"获取购物车失败",icon:"none"})},fail:e=>{this.loading=!1,t("error","at pages/order/confirm.vue:287","获取购物车失败",e),uni.showToast({title:"网络请求失败",icon:"none"})}})},loadUserCoupons(){if(!uni.getStorageSync("token"))return void t("log","at pages/order/confirm.vue:300","未找到token，无法获取优惠券");const e=this.calculateTotalPrice();r.getCoupons(0).then((t=>{if(200===t.statusCode){let o=[];if(!(t.data&&200===t.data.code&&t.data.data&&t.data.data.content))return void(this.availableCoupons=[]);if(o=t.data.data.content,0===o.length)return void(this.availableCoupons=[]);let a=o.map((t=>{const o=t.coupon||t,a=parseFloat(o.minConsumption||o.minPoint||o.min_point||o.minAmount||0),s=parseInt(o.type||1),n=parseFloat(o.amount||0);let r=void 0!==t.canUse?t.canUse:e>=a;return{id:t.id||o.id||"",couponId:o.id||"",name:o.name||"优惠券",amount:n,type:s,typeText:o.typeText||(2===s?"折扣券":"满减券"),description:o.description||"",minConsumption:a,startTime:o.startTime||"",endTime:o.endTime||"",expireDate:o.endTime||"",status:t.status||0,statusText:t.statusText||"未使用",canUse:r}}));this.availableCoupons=a.filter((e=>0===e.status||"未使用"===e.statusText)),this.availableCoupons.sort(((t,o)=>{if(t.canUse!==o.canUse)return t.canUse?-1:1;if(t.canUse){const a=2===t.type?e*(1-t.amount):t.amount;return(2===o.type?e*(1-o.amount):o.amount)-a}return t.minConsumption-o.minConsumption}))}else this.availableCoupons=[]})).catch((e=>{t("error","at pages/order/confirm.vue:400","获取优惠券请求失败，错误详情:",e),this.availableCoupons=[]}))},openCouponModal(){this.showCouponModal=!0},closeCouponModal(){this.showCouponModal=!1},selectCoupon(e){e.canUse?(this.selectedCoupon=e,this.showCouponModal=!1):this.showMinAmountTips(e)},selectNoCoupon(){this.selectedCoupon=null,this.showCouponModal=!1},confirmCouponSelection(){this.showCouponModal=!1},selectPayment(e){this.paymentMethod=e},calculateItemPrice(e){if(t("log","at pages/order/confirm.vue:445","计算商品价格:",e),!e)return t("error","at pages/order/confirm.vue:449","商品数据为空"),0;let o=0;if(e.product&&void 0!==e.product.price)o=e.product.price;else if(void 0!==e.productPrice)o=e.productPrice;else{if(void 0===e.price)return 0;o=e.price}if(o=parseFloat(o)||0,e.ingredients&&e.ingredients.length>0){o+=e.ingredients.reduce(((e,t)=>e+(parseFloat(t.price)||0)),0)}return o*(parseInt(e.quantity)||1)},calculateTotalPrice(){return this.cartItems.reduce(((e,t)=>e+this.calculateItemPrice(t)),0)},calculateFinalPrice(){let e=this.calculateTotalPrice();if(this.selectedCoupon)if(2===this.selectedCoupon.type){e-=e*(1-this.selectedCoupon.amount)}else e=Math.max(0,e-this.selectedCoupon.amount);return this.memberDiscount<1&&(e=Math.round(e*this.memberDiscount*100)/100),e>0?e:0},getCouponDiscountAmount(){if(!this.selectedCoupon)return 0;const e=this.calculateTotalPrice();return 2===this.selectedCoupon.type?e*(1-this.selectedCoupon.amount):this.selectedCoupon.amount},getMemberDiscountAmount(){if(this.memberDiscount>=1)return 0;let e=this.getPriceAfterCoupon()*(1-this.memberDiscount);return e=Math.round(100*e)/100,e},getPriceAfterCoupon(){const e=this.calculateTotalPrice();return this.selectedCoupon?2===this.selectedCoupon.type?e*this.selectedCoupon.amount:Math.max(0,e-this.selectedCoupon.amount):e},submitOrder(){var e;if(0===this.cartItems.length)return void uni.showToast({title:"请先选择商品",icon:"none"});uni.showLoading({title:"提交中..."});const o={cartIds:this.cartItems.map((e=>e.id||0)).filter((e=>e>0)),directProduct:1===this.cartItems.length&&this.cartItems[0].directBuy?{productId:this.cartItems[0].productId||(null==(e=this.cartItems[0].product)?void 0:e.id),quantity:this.cartItems[0].quantity||1,cartId:this.cartItems[0].id||0,temperature:this.cartItems[0].temperature||"",sweetness:this.cartItems[0].sweetness||"",ingredients:(this.cartItems[0].ingredients||[]).map((e=>({id:e.id||0,name:e.name||"",price:e.price||0}))),selected:!0}:null,remark:this.note||"",userCouponId:this.selectedCoupon?this.selectedCoupon.id||0:null};o.directProduct||delete o.directProduct,o.userCouponId||delete o.userCouponId;if(!uni.getStorageSync("token"))return uni.hideLoading(),void uni.navigateTo({url:"/pages/login/login"});r.createOrder(o).then((e=>{if(uni.hideLoading(),200===e.statusCode||201===e.statusCode){let o,a;e.data&&200===e.data.code&&e.data.data?(o=e.data.data.id||e.data.data.orderId,a=e.data.data.orderNo):e.data&&(o=e.data.orderId||e.data.id,a=e.data.orderNo),o||a?(uni.showToast({title:"订单提交成功",icon:"success",duration:2e3}),this.cartItems.length>0&&this.clearSelectedCartItems(),setTimeout((()=>{uni.navigateTo({url:`/pages/order/detail?orderNo=${a||o}`})}),1500)):(uni.showToast({title:"订单数据异常",icon:"none"}),t("error","at pages/order/confirm.vue:663","订单创建成功但返回数据异常",e.data))}else{let o="创建订单失败";e.data&&e.data.message&&(o=e.data.message),uni.showToast({title:o,icon:"none",duration:2e3}),t("error","at pages/order/confirm.vue:676","创建订单失败:",e)}})).catch((e=>{uni.hideLoading(),t("error","at pages/order/confirm.vue:681","提交订单失败:",e),uni.showToast({title:"网络请求失败，请稍后再试",icon:"none",duration:2e3})}))},clearSelectedCartItems(){uni.getStorageSync("token")&&r.request({url:"/cart/selected",method:"DELETE",success:e=>{t("log","at pages/order/confirm.vue:700","移除已选择的购物车商品成功:",e.data)},fail:e=>{t("error","at pages/order/confirm.vue:703","移除购物车商品失败:",e)}})},getProductImage:e=>e.product&&e.product.image?e.product.image:e.productImage?e.productImage:"/static/default-product.png",getProductName:e=>e.product&&e.product.name?e.product.name:e.productName?e.productName:"未知商品",hasIngredients:e=>e.ingredients&&e.ingredients.length>0,formatIngredients(e){return this.hasIngredients(e)?e.ingredients.map((e=>e.name||e)).join("、"):""},showMinAmountTips(e){const t=e.minConsumption-this.calculateTotalPrice();uni.showToast({title:`还差¥${t.toFixed(2)}才能使用此${2===e.type?"折扣":""}优惠券`,icon:"none",duration:2e3})},getMemberInfo(){uni.getStorageSync("token")&&r.getMemberInfo().then((e=>{t("log","at pages/order/confirm.vue:760","获取会员信息响应状态码:",e.statusCode),t("log","at pages/order/confirm.vue:761","获取会员信息完整响应:",JSON.stringify(e.data)),200===e.statusCode&&e.data&&200===e.data.code?(this.memberInfo=e.data.data,this.memberInfo&&this.memberInfo.discount&&(this.memberDiscount=parseFloat(this.memberInfo.discount))):t("error","at pages/order/confirm.vue:771","获取会员信息失败:",e.data)})).catch((e=>{t("error","at pages/order/confirm.vue:775","获取会员信息请求失败:",e)}))}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"confirm-container"},[n.loading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading"},[e.createElementVNode("text",null,"加载中...")])):(e.openBlock(),e.createElementBlock("scroll-view",{key:1,"scroll-y":"",class:"confirm-content"},[e.createElementVNode("view",{class:"product-section"},[e.createElementVNode("view",{class:"section-title"},"已选商品"),e.createElementVNode("view",{class:"product-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.cartItems,(t=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:"product-item"},[e.createElementVNode("image",{src:r.getProductImage(t),mode:"aspectFill",class:"product-image"},null,8,["src"]),e.createElementVNode("view",{class:"product-info"},[e.createElementVNode("view",{class:"product-top"},[e.createElementVNode("view",{class:"product-name"},e.toDisplayString(r.getProductName(t)),1),e.createElementVNode("view",{class:"product-quantity"},"x"+e.toDisplayString(t.quantity||1),1)]),t.temperature||t.sweetness||r.hasIngredients(t)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"product-options"},[t.temperature?(e.openBlock(),e.createElementBlock("text",{key:0},e.toDisplayString(t.temperature),1)):e.createCommentVNode("",!0),t.sweetness?(e.openBlock(),e.createElementBlock("text",{key:1},e.toDisplayString(t.sweetness),1)):e.createCommentVNode("",!0),r.hasIngredients(t)?(e.openBlock(),e.createElementBlock("text",{key:2},e.toDisplayString(r.formatIngredients(t)),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"product-price"},"¥"+e.toDisplayString(r.calculateItemPrice(t).toFixed(2)),1)])])))),128))])]),e.createElementVNode("view",{class:"coupon-section",onClick:o[0]||(o[0]=(...e)=>r.openCouponModal&&r.openCouponModal(...e))},[e.createElementVNode("view",{class:"section-title"},"优惠券"),e.createElementVNode("view",{class:"coupon-right"},[n.selectedCoupon?(e.openBlock(),e.createElementBlock("text",{key:0,class:"coupon-value"}," 已选择："+e.toDisplayString(n.selectedCoupon.name)+" -¥"+e.toDisplayString(n.selectedCoupon.amount.toFixed(2)),1)):(e.openBlock(),e.createElementBlock("text",{key:1,class:"no-coupon"},"未使用优惠券")),e.createElementVNode("text",{class:"arrow"},">")])]),e.createElementVNode("view",{class:"note-section"},[e.createElementVNode("view",{class:"section-title"},"备注"),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":o[1]||(o[1]=e=>n.note=e),placeholder:"有什么特殊要求可以告诉我们哦~",class:"note-input"},null,512),[[e.vModelText,n.note]])]),e.createElementVNode("view",{class:"price-detail"},[e.createElementVNode("view",{class:"price-row"},[e.createElementVNode("text",{class:"price-label"},"商品金额"),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(r.calculateTotalPrice().toFixed(2)),1)]),n.selectedCoupon?(e.openBlock(),e.createElementBlock("view",{key:0,class:"price-row"},[e.createElementVNode("text",{class:"price-label"},"优惠券"+e.toDisplayString(2===n.selectedCoupon.type?"("+(10*n.selectedCoupon.amount).toFixed(1)+"折)":""),1),e.createElementVNode("text",{class:"price-value discount"},"-¥"+e.toDisplayString(r.getCouponDiscountAmount().toFixed(2)),1)])):e.createCommentVNode("",!0),n.selectedCoupon?(e.openBlock(),e.createElementBlock("view",{key:1,class:"price-row"},[e.createElementVNode("text",{class:"price-label"},"优惠后金额"),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(r.getPriceAfterCoupon().toFixed(2)),1)])):e.createCommentVNode("",!0),n.memberDiscount<1?(e.openBlock(),e.createElementBlock("view",{key:2,class:"price-row"},[e.createElementVNode("text",{class:"price-label"},"会员折扣 ("+e.toDisplayString((10*n.memberDiscount).toFixed(1))+"折)",1),e.createElementVNode("text",{class:"price-value discount"},"-¥"+e.toDisplayString(r.getMemberDiscountAmount().toFixed(2)),1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"price-row"},[e.createElementVNode("text",{class:"price-label"},"实付金额"),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(r.calculateFinalPrice().toFixed(2)),1)])]),e.createElementVNode("view",{class:"bottom-placeholder"})])),e.createElementVNode("view",{class:"checkout-bar"},[e.createElementVNode("view",{class:"total-section"},[e.createElementVNode("text",{class:"total-text"},"总价："),e.createElementVNode("text",{class:"total-price"},"¥"+e.toDisplayString(r.calculateFinalPrice().toFixed(2)),1)]),e.createElementVNode("button",{class:"submit-btn",onClick:o[2]||(o[2]=(...e)=>r.submitOrder&&r.submitOrder(...e))},"提交订单")]),n.showCouponModal?(e.openBlock(),e.createElementBlock("view",{key:2,class:"coupon-modal"},[e.createElementVNode("view",{class:"coupon-modal-mask",onClick:o[3]||(o[3]=(...e)=>r.closeCouponModal&&r.closeCouponModal(...e))}),e.createElementVNode("view",{class:"coupon-modal-container"},[e.createElementVNode("view",{class:"coupon-modal-header"},[e.createElementVNode("text",{class:"coupon-modal-title"},"选择优惠券"),e.createElementVNode("text",{class:"coupon-modal-close",onClick:o[4]||(o[4]=(...e)=>r.closeCouponModal&&r.closeCouponModal(...e))},"×")]),e.createElementVNode("view",{class:"coupon-modal-content"},[n.availableCoupons.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"coupon-list"},[e.createElementVNode("view",{class:e.normalizeClass(["coupon-card",{selected:null===n.selectedCoupon}]),onClick:o[5]||(o[5]=(...e)=>r.selectNoCoupon&&r.selectNoCoupon(...e))},[e.createElementVNode("view",{class:"coupon-left"},[e.createElementVNode("text",{class:"coupon-amount"},"不使用")]),e.createElementVNode("view",{class:"coupon-right"},[e.createElementVNode("text",{class:"coupon-name"},"不使用优惠券"),e.createElementVNode("text",{class:"coupon-desc"},"无需使用优惠券")]),null===n.selectedCoupon?(e.openBlock(),e.createElementBlock("view",{key:0,class:"coupon-select-icon"},[e.createElementVNode("text",{class:"check-icon"},"✓")])):e.createCommentVNode("",!0)],2),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.availableCoupons,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["coupon-card",{selected:n.selectedCoupon&&n.selectedCoupon.id===t.id,disabled:!t.canUse}]),onClick:e=>t.canUse?r.selectCoupon(t):r.showMinAmountTips(t)},[e.createElementVNode("view",{class:"coupon-left"},[1===t.type?(e.openBlock(),e.createElementBlock("text",{key:0,class:"coupon-amount"},"¥"+e.toDisplayString(t.amount.toFixed(2)),1)):(e.openBlock(),e.createElementBlock("text",{key:1,class:"coupon-amount"},e.toDisplayString((10*t.amount).toFixed(1))+"折",1)),t.minConsumption>0?(e.openBlock(),e.createElementBlock("text",{key:2,class:e.normalizeClass(["coupon-condition",{"condition-not-met":!t.canUse}])},"满"+e.toDisplayString(t.minConsumption.toFixed(2))+"可用",3)):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"coupon-right"},[e.createElementVNode("text",{class:"coupon-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:"coupon-desc"},e.toDisplayString(t.description||t.typeText),1),e.createElementVNode("text",{class:"coupon-date"},"有效期至"+e.toDisplayString(t.expireDate),1)]),n.selectedCoupon&&n.selectedCoupon.id===t.id?(e.openBlock(),e.createElementBlock("view",{key:0,class:"coupon-select-icon"},[e.createElementVNode("text",{class:"check-icon"},"✓")])):e.createCommentVNode("",!0),t.canUse?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"coupon-disabled-mask"}))],10,["onClick"])))),128))])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"no-coupons"},[e.createElementVNode("text",null,"暂无可用优惠券")]))]),e.createElementVNode("view",{class:"coupon-modal-footer"},[e.createElementVNode("button",{class:"cancel-btn",onClick:o[6]||(o[6]=(...e)=>r.closeCouponModal&&r.closeCouponModal(...e))},"取消"),e.createElementVNode("button",{class:"confirm-btn",onClick:o[7]||(o[7]=(...e)=>r.confirmCouponSelection&&r.confirmCouponSelection(...e))},"确定")])])])):e.createCommentVNode("",!0)])}]]);const C=i({data:()=>({keyword:"",searchHistory:[],searching:!1,loading:!1,loadingMore:!1,searchResults:[],page:0,size:10,hasMore:!0,searchTimer:null,hasSearched:!1,showDetail:!1,currentProduct:{},quantity:1,popupStyle:{transform:"translateY(100%)",transition:"none"},maskStyle:{opacity:0,transition:"none"},contentStyle:{opacity:0,transition:"none"},temperatures:["常温","热","冰","少冰"],sweetness:["标准糖","少糖","半糖","微糖","无糖"],ingredients:[],selectedTemp:"常温",selectedSweet:"标准糖",selectedIngredients:[]}),onLoad(){this.loadSearchHistory(),this.loadIngredients()},methods:{loadIngredients(){r.getIngredients().then((e=>{t("log","at pages/menu/search.vue:262","获取配料列表响应:",e.data),200===e.data.code?this.ingredients=e.data.data:this.showToast(e.data.message||"获取配料列表失败")})).catch((e=>{t("error","at pages/menu/search.vue:270","网络请求失败:",e),this.showToast("网络请求失败")}))},onKeywordInput(){if(this.searching=!0,this.searchTimer&&clearTimeout(this.searchTimer),!this.keyword.trim())return this.searchResults=[],void(this.searching=!!this.keyword);this.searchTimer=setTimeout((()=>{this.searchProducts()}),300)},searchProducts(){this.hasSearched=!0,this.keyword.trim()&&this.saveKeywordToHistory(this.keyword),this.page=0,this.hasMore=!0,this.loading=!0,r.request({url:"/product/search",method:"GET",data:{keyword:this.keyword,page:this.page,size:this.size}}).then((e=>{t("log","at pages/menu/search.vue:326","搜索产品响应:",e.data),200===e.data.code?(this.searchResults=e.data.data.content||[],this.hasMore=this.searchResults.length>=this.size):(this.searchResults=[],this.showToast(e.data.message||"搜索失败"))})).catch((e=>{t("error","at pages/menu/search.vue:337","网络请求失败:",e),this.showToast("网络请求失败"),this.searchResults=[]})).finally((()=>{this.loading=!1}))},saveKeywordToHistory(e){const t=this.searchHistory.indexOf(e);t>-1&&this.searchHistory.splice(t,1),this.searchHistory.unshift(e),this.searchHistory.length>10&&this.searchHistory.pop(),this.saveSearchHistory()},loadMoreResults(){!this.hasMore||this.loadingMore||this.loading||(this.loadingMore=!0,this.page++,r.request({url:"/product/search",method:"GET",data:{keyword:this.keyword,page:this.page,size:this.size}}).then((e=>{if(t("log","at pages/menu/search.vue:383","加载更多搜索结果:",e.data),200===e.data.code){const t=e.data.data.content||[];this.searchResults=[...this.searchResults,...t],this.hasMore=t.length>=this.size}else this.showToast(e.data.message||"加载更多失败")})).catch((e=>{t("error","at pages/menu/search.vue:395","网络请求失败:",e),this.showToast("网络请求失败")})).finally((()=>{this.loadingMore=!1})))},clearKeyword(){this.keyword="",this.searchResults=[],this.searching=!1,this.searchTimer&&clearTimeout(this.searchTimer)},useHistoryKeyword(e){this.keyword=e,this.searchProducts()},loadSearchHistory(){const e=uni.getStorageSync("searchHistory");e&&(this.searchHistory=JSON.parse(e))},saveSearchHistory(){uni.setStorageSync("searchHistory",JSON.stringify(this.searchHistory))},clearHistory(){uni.showModal({title:"提示",content:"确定要清空搜索历史吗？",success:e=>{e.confirm&&(this.searchHistory=[],uni.removeStorageSync("searchHistory"))}})},showProductDetail(e){this.resetProductOptions(),this.showDetail=!0,this.popupStyle={transform:"translateY(100%)",transition:"none"},this.maskStyle={opacity:0,transition:"none"},this.contentStyle={opacity:0,transition:"none"},this.$nextTick((()=>{setTimeout((()=>{r.request({url:`/product/detail/${e.id}`,method:"GET"}).then((e=>{t("log","at pages/menu/search.vue:477","获取商品详情响应:",e.data),200===e.data.code?(this.currentProduct=e.data.data,this.openDetailPopup()):(this.showToast(e.data.message||"获取商品详情失败"),this.showDetail=!1)})).catch((e=>{t("error","at pages/menu/search.vue:487","网络请求失败:",e),this.showToast("网络请求失败"),this.showDetail=!1}))}),50)}))},openDetailPopup(){this.maskStyle={opacity:1,transition:"opacity 0.2s ease-out"},setTimeout((()=>{this.popupStyle={transform:"translateY(0)",transition:"transform 0.3s ease-out"},setTimeout((()=>{this.contentStyle={opacity:1,transition:"opacity 0.2s ease-out"}}),150)}),100)},resetProductOptions(){this.quantity=1,this.selectedTemp="常温",this.selectedSweet="标准糖",this.selectedIngredients=[]},hideProductDetail(){this.contentStyle={opacity:0,transition:"opacity 0.2s ease-in"},setTimeout((()=>{this.popupStyle={transform:"translateY(100%)",transition:"transform 0.3s ease-in"},setTimeout((()=>{this.maskStyle={opacity:0,transition:"opacity 0.2s ease-in"},setTimeout((()=>{this.showDetail=!1}),200)}),150)}),100)},adjustQuantity(e){const t=this.quantity+e;t>=1&&t<=99&&(this.quantity=t)},toggleIngredient(e){const o=this.selectedIngredients.findIndex((t=>t.id===e.id));if(o>-1)this.selectedIngredients.splice(o,1);else{const o={id:e.id,name:e.name,price:e.price};t("log","at pages/menu/search.vue:578","添加配料:",o),this.selectedIngredients.push(o)}},getTotalPrice(){if(!this.currentProduct.price)return 0;let e=this.currentProduct.price*this.quantity;return this.selectedIngredients.forEach((t=>{e+=t.price*this.quantity})),e},addToCart(){if(!uni.getStorageSync("token"))return void uni.showModal({title:"未登录提示",content:"您尚未登录，是否前往登录页面？",confirmText:"去登录",cancelText:"取消",success:e=>{e.confirm&&this.redirectToLogin()}});let e=[];this.selectedIngredients&&this.selectedIngredients.length>0&&(e=this.selectedIngredients.map((e=>({id:e.id,name:e.name,price:e.price}))));const o={productId:this.currentProduct.id,quantity:this.quantity,temperature:this.selectedTemp,sweetness:this.selectedSweet,ingredients:e,forceNewItem:!0,selected:!0};r.request({url:"/cart",method:"POST",data:o}).then((e=>{t("log","at pages/menu/search.vue:645","添加到购物车响应:",e.data),200===e.data.code?(this.showToast("已添加到购物车","success"),this.hideProductDetail()):401===e.data.code?this.handleTokenExpired():this.showToast(e.data.message||"添加到购物车失败")})).catch((e=>{t("error","at pages/menu/search.vue:656","网络请求失败:",e),this.showToast("网络请求失败")}))},goBack(){uni.navigateBack()},redirectToLogin(){uni.navigateTo({url:"/pages/login/login"})},handleTokenExpired(){uni.removeStorageSync("token"),uni.showToast({title:"登录已过期，请重新登录",icon:"none"}),setTimeout((()=>{this.redirectToLogin()}),1500)},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"search-container"},[e.createElementVNode("view",{class:"navbar"},[e.createElementVNode("text",{class:"page-title"},"搜索")]),e.createElementVNode("view",{class:"search-header"},[e.createElementVNode("view",{class:"search-box"},[e.createElementVNode("image",{src:l,class:"search-icon"}),e.withDirectives(e.createElementVNode("input",{type:"text",class:"search-input",placeholder:"搜索奶茶、果茶、小吃","placeholder-style":"color: #888888;","onUpdate:modelValue":o[0]||(o[0]=e=>n.keyword=e),onInput:o[1]||(o[1]=(...e)=>r.onKeywordInput&&r.onKeywordInput(...e)),focus:""},null,544),[[e.vModelText,n.keyword]]),n.keyword?(e.openBlock(),e.createElementBlock("view",{key:0,class:"clear-icon",onClick:o[2]||(o[2]=(...e)=>r.clearKeyword&&r.clearKeyword(...e))},[e.createElementVNode("image",{src:m,class:"close-icon-small"})])):e.createCommentVNode("",!0)]),e.createElementVNode("text",{class:"cancel-btn",onClick:o[3]||(o[3]=(...e)=>r.goBack&&r.goBack(...e))},"取消")]),!n.keyword&&n.searchHistory.length>0&&!n.searching?(e.openBlock(),e.createElementBlock("view",{key:0,class:"search-history"},[e.createElementVNode("view",{class:"section-header"},[e.createElementVNode("text",{class:"section-title"},"搜索历史"),e.createElementVNode("text",{class:"clear-btn",onClick:o[4]||(o[4]=(...e)=>r.clearHistory&&r.clearHistory(...e))},"清空")]),e.createElementVNode("view",{class:"history-tags"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.searchHistory,((t,o)=>(e.openBlock(),e.createElementBlock("view",{class:"history-tag",key:o,onClick:e=>r.useHistoryKeyword(t)},[e.createElementVNode("text",null,e.toDisplayString(t),1)],8,["onClick"])))),128))])])):e.createCommentVNode("",!0),n.loading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading-box"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"搜索中...")])):e.createCommentVNode("",!0),!n.loading&&n.searchResults.length>0?(e.openBlock(),e.createElementBlock("scroll-view",{key:2,"scroll-y":"",class:"search-results",onScrolltolower:o[5]||(o[5]=(...e)=>r.loadMoreResults&&r.loadMoreResults(...e))},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.searchResults,(t=>(e.openBlock(),e.createElementBlock("view",{class:"product-item",key:t.id,onClick:e=>r.showProductDetail(t)},[e.createElementVNode("image",{src:t.image||"/static/default-product.png",class:"product-image",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"product-info"},[e.createElementVNode("view",{class:"product-name"},e.toDisplayString(t.name),1),t.description?(e.openBlock(),e.createElementBlock("view",{key:0,class:"product-description"},e.toDisplayString(t.description),1)):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"product-bottom"},[e.createElementVNode("text",{class:"product-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1),e.createElementVNode("view",{class:"add-to-cart-btn",onClick:e.withModifiers((e=>r.showProductDetail(t)),["stop"])},[e.createElementVNode("image",{src:d,class:"add-icon"})],8,["onClick"])])])],8,["onClick"])))),128)),n.hasMore&&!n.loadingMore?(e.openBlock(),e.createElementBlock("view",{key:0,class:"load-more"},[e.createElementVNode("text",null,"上拉加载更多")])):n.hasMore?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"load-more"},[e.createElementVNode("text",null,"已加载全部")])),n.loadingMore?(e.openBlock(),e.createElementBlock("view",{key:2,class:"loading-more"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0)],32)):e.createCommentVNode("",!0),n.hasSearched&&0===n.searchResults.length?(e.openBlock(),e.createElementBlock("view",{key:3,class:"no-results"},[e.createElementVNode("image",{src:"/static/tabbar/menu.png",class:"empty-icon"}),e.createElementVNode("text",{class:"no-results-text"},"没有找到相关商品")])):e.createCommentVNode("",!0),e.withDirectives(e.createElementVNode("view",{class:"product-detail-popup"},[e.createElementVNode("view",{class:"popup-mask",onClick:o[6]||(o[6]=(...e)=>r.hideProductDetail&&r.hideProductDetail(...e)),style:e.normalizeStyle(n.maskStyle)},null,4),e.createElementVNode("view",{class:"popup-content",style:e.normalizeStyle(n.popupStyle)},[e.createElementVNode("view",{class:"popup-inner",style:e.normalizeStyle(n.contentStyle)},[e.createElementVNode("view",{class:"close-btn",onClick:o[7]||(o[7]=(...e)=>r.hideProductDetail&&r.hideProductDetail(...e))},[e.createElementVNode("image",{src:m,class:"close-icon"})]),e.createElementVNode("view",{class:"detail-header"},[e.createElementVNode("image",{src:n.currentProduct.image||"/static/images/default-product.svg",class:"detail-image",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"detail-basic-info"},[e.createElementVNode("view",{class:"name-price-row"},[e.createElementVNode("text",{class:"detail-name"},e.toDisplayString(n.currentProduct.name),1),e.createElementVNode("text",{class:"detail-price"},"¥"+e.toDisplayString(n.currentProduct.price?n.currentProduct.price.toFixed(2):"0.00"),1)]),n.currentProduct.sales?(e.openBlock(),e.createElementBlock("text",{key:0,class:"detail-sales"},"销量: "+e.toDisplayString(n.currentProduct.sales),1)):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:"specifications"},[e.createElementVNode("view",{class:"spec-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:u,class:"spec-icon"}),e.createElementVNode("text",{class:"spec-title"},"温度")]),e.createElementVNode("view",{class:"spec-options"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.temperatures,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["spec-option",n.selectedTemp===t?"selected":""]),onClick:e=>n.selectedTemp=t},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))])]),e.createElementVNode("view",{class:"spec-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:h,class:"spec-icon"}),e.createElementVNode("text",{class:"spec-title"},"甜度")]),e.createElementVNode("view",{class:"spec-options"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.sweetness,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["spec-option",n.selectedSweet===t?"selected":""]),onClick:e=>n.selectedSweet=t},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))])]),n.ingredients.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"spec-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:p,class:"spec-icon"}),e.createElementVNode("text",{class:"spec-title"},"加料")]),e.createElementVNode("view",{class:"ingredient-options"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.ingredients,(t=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:e.normalizeClass(["ingredient-item",n.selectedIngredients.findIndex((e=>e.id===t.id))>-1?"selected":""]),onClick:e=>r.toggleIngredient(t)},[e.createElementVNode("text",{class:"ingredient-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:"ingredient-price"},"¥"+e.toDisplayString(t.price.toFixed(2)),1)],10,["onClick"])))),128))])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"quantity-section"},[e.createElementVNode("view",{class:"spec-title-row"},[e.createElementVNode("image",{src:g,class:"spec-icon"}),e.createElementVNode("text",{class:"quantity-label"},"数量")]),e.createElementVNode("view",{class:"quantity-control"},[e.createElementVNode("text",{class:"quantity-btn minus",onClick:o[8]||(o[8]=e=>r.adjustQuantity(-1))},"-"),e.withDirectives(e.createElementVNode("input",{type:"number",class:"quantity-input","onUpdate:modelValue":o[9]||(o[9]=e=>n.quantity=e),disabled:""},null,512),[[e.vModelText,n.quantity]]),e.createElementVNode("text",{class:"quantity-btn plus",onClick:o[10]||(o[10]=e=>r.adjustQuantity(1))},"+")])]),e.createElementVNode("view",{class:"detail-footer"},[e.createElementVNode("view",{class:"total-price"},[e.createElementVNode("text",null,"总计："),e.createElementVNode("text",{class:"price-value"},"¥"+e.toDisplayString(r.getTotalPrice().toFixed(2)),1)]),e.createElementVNode("view",{class:"add-to-cart",onClick:o[11]||(o[11]=(...e)=>r.addToCart&&r.addToCart(...e))},[e.createElementVNode("text",null,"加入购物车")])])],4)],4)],512),[[e.vShow,n.showDetail]])])}],["__scopeId","data-v-50da2392"]]);const S=i({data:()=>({token:uni.getStorageSync("token")||""}),onLoad(){this.checkLoginStatus()},methods:{checkLoginStatus(){uni.getStorageSync("token")||this.promptLogin()},changePassword(){uni.navigateTo({url:"/pages/user/change-password"})},changePhone(){uni.navigateTo({url:"/pages/user/change-phone"})},updateUserInfo(){uni.navigateTo({url:"/pages/user/user-info"})},logout(){uni.showModal({title:"提示",content:"确定要退出登录吗？",success:e=>{e.confirm&&this.handleLogout()}})},handleLogout(){uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),uni.reLaunch({url:"/pages/login/login"}),this.showToast("已退出登录","success")},promptLogin(){uni.showModal({title:"提示",content:"请先登录",confirmText:"去登录",success:e=>{e.confirm?uni.navigateTo({url:"/pages/login/login"}):uni.navigateBack()}})},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"settings-container"},[e.createElementVNode("view",{class:"settings-header"},[e.createElementVNode("view",{class:"header-title"},"设置")]),e.createElementVNode("view",{class:"settings-section"},[e.createElementVNode("view",{class:"section-title"},"账户设置"),e.createElementVNode("view",{class:"settings-list"},[e.createElementVNode("view",{class:"settings-item",onClick:o[0]||(o[0]=(...e)=>r.changePassword&&r.changePassword(...e))},[e.createElementVNode("image",{src:"/static/icons/settings/password.svg",class:"settings-icon-img"}),e.createElementVNode("text",{class:"settings-text"},"修改密码"),e.createElementVNode("text",{class:"arrow"},">")]),e.createElementVNode("view",{class:"settings-item",onClick:o[1]||(o[1]=(...e)=>r.changePhone&&r.changePhone(...e))},[e.createElementVNode("image",{src:"/static/icons/settings/phone.svg",class:"settings-icon-img"}),e.createElementVNode("text",{class:"settings-text"},"更换手机号"),e.createElementVNode("text",{class:"arrow"},">")]),e.createElementVNode("view",{class:"settings-item",onClick:o[2]||(o[2]=(...e)=>r.updateUserInfo&&r.updateUserInfo(...e))},[e.createElementVNode("image",{src:"/static/icons/settings/user.svg",class:"settings-icon-img"}),e.createElementVNode("text",{class:"settings-text"},"修改个人信息"),e.createElementVNode("text",{class:"arrow"},">")])])]),e.createElementVNode("view",{class:"settings-section"},[e.createElementVNode("view",{class:"logout-btn"},[e.createElementVNode("button",{type:"default",onClick:o[3]||(o[3]=(...e)=>r.logout&&r.logout(...e))},"退出登录")])])])}]]);const B=i({data:()=>({oldPassword:"",newPassword:"",confirmPassword:"",loading:!1}),onLoad(){this.checkLoginStatus()},methods:{checkLoginStatus(){uni.getStorageSync("token")||this.promptLogin()},promptLogin(){uni.showModal({title:"提示",content:"请先登录",confirmText:"去登录",success:e=>{e.confirm?uni.navigateTo({url:"/pages/login/login"}):uni.navigateBack()}})},validatePassword(){return this.oldPassword?this.newPassword?this.newPassword.length<8?(this.showToast("新密码长度不能少于8个字符"),!1):/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$/.test(this.newPassword)?this.newPassword===this.oldPassword?(this.showToast("新密码不能与原密码相同"),!1):this.newPassword===this.confirmPassword||(this.showToast("两次输入的新密码不一致"),!1):(this.showToast("新密码必须包含大小写字母和数字"),!1):(this.showToast("请输入新密码"),!1):(this.showToast("请输入原密码"),!1)},submitPassword(){this.validatePassword()&&(this.loading=!0,r.request({url:"/user/change-password",method:"PUT",data:{oldPassword:this.oldPassword,newPassword:this.newPassword},success:e=>{200===e.data.code?(this.showToast("密码修改成功，请重新登录","success"),uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),setTimeout((()=>{uni.reLaunch({url:"/pages/login/login"})}),1500)):this.showToast(e.data.message||"密码修改失败")},fail:()=>{this.showToast("网络错误，请稍后再试")},complete:()=>{this.loading=!1}}))},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"change-password-container"},[e.createElementVNode("view",{class:"password-header"},[e.createElementVNode("view",{class:"header-title"},"修改密码")]),e.createElementVNode("view",{class:"password-form"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"原密码"),e.withDirectives(e.createElementVNode("input",{type:"password","onUpdate:modelValue":o[0]||(o[0]=e=>n.oldPassword=e),placeholder:"请输入原密码",class:"form-input","placeholder-style":"color: #666666;"},null,512),[[e.vModelText,n.oldPassword]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"新密码"),e.withDirectives(e.createElementVNode("input",{type:"password","onUpdate:modelValue":o[1]||(o[1]=e=>n.newPassword=e),placeholder:"请输入新密码",class:"form-input","placeholder-style":"color: #666666;"},null,512),[[e.vModelText,n.newPassword]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"确认新密码"),e.withDirectives(e.createElementVNode("input",{type:"password","onUpdate:modelValue":o[2]||(o[2]=e=>n.confirmPassword=e),placeholder:"请再次输入新密码",class:"form-input","placeholder-style":"color: #666666;"},null,512),[[e.vModelText,n.confirmPassword]])]),e.createElementVNode("view",{class:"password-rules"},[e.createElementVNode("text",{class:"rules-title"},"密码要求："),e.createElementVNode("text",{class:"rules-item"},"• 不少于8个字符"),e.createElementVNode("text",{class:"rules-item"},"• 包含大小写字母和数字"),e.createElementVNode("text",{class:"rules-item"},"• 不能与旧密码相同")]),e.createElementVNode("button",{class:"submit-btn",onClick:o[3]||(o[3]=(...e)=>r.submitPassword&&r.submitPassword(...e))},"确认修改")])])}]]);const D=i({data:()=>({currentPhone:"",newPhone:"",loading:!1}),onLoad(){this.checkLoginStatus(),this.getUserInfo()},methods:{checkLoginStatus(){uni.getStorageSync("token")||this.promptLogin()},getUserInfo(){const e=uni.getStorageSync("userInfo");if(e&&e.phone)this.currentPhone=e.phone;else{if(!uni.getStorageSync("token"))return void this.promptLogin();r.getUserInfo().then((e=>{200===e.data.code&&e.data.data?(this.currentPhone=e.data.data.phone||"",uni.setStorageSync("userInfo",e.data.data)):403===e.data.code&&(this.showToast("登录已过期，请重新登录"),setTimeout((()=>{uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),uni.reLaunch({url:"/pages/login/login"})}),1500))})).catch((e=>{t("error","at pages/user/change-phone.vue:82","获取用户信息失败:",e),403===e.statusCode&&(this.showToast("登录已过期，请重新登录"),setTimeout((()=>{uni.reLaunch({url:"/pages/login/login"})}),1500))}))}},maskPhone:e=>e&&11===e.length?e.substring(0,3)+"****"+e.substring(7):"",validatePhone(){return this.newPhone?/^1[3-9]\d{9}$/.test(this.newPhone)?this.newPhone!==this.currentPhone||(this.showToast("新手机号不能与当前手机号相同"),!1):(this.showToast("请输入正确的手机号格式"),!1):(this.showToast("请输入新手机号"),!1)},submitChange(){if(!this.validatePhone())return;this.loading=!0;if(!uni.getStorageSync("token"))return this.showToast("请先登录"),void this.promptLogin();r.updateUserInfo({phone:this.newPhone}).then((e=>{if(200===e.data.code){this.showToast("手机号更换成功","success");const e=uni.getStorageSync("userInfo")||{};e.phone=this.newPhone,uni.setStorageSync("userInfo",e),setTimeout((()=>{uni.navigateBack()}),1500)}else 403===e.data.code?(this.showToast("没有权限，请重新登录"),setTimeout((()=>{uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),uni.reLaunch({url:"/pages/login/login"})}),1500)):this.showToast(e.data.message||"手机号更换失败")})).catch((e=>{t("error","at pages/user/change-phone.vue:176","请求失败:",e),403===e.statusCode?(this.showToast("登录已过期，请重新登录"),setTimeout((()=>{uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),uni.reLaunch({url:"/pages/login/login"})}),1500)):this.showToast("网络错误，请稍后再试")})).finally((()=>{this.loading=!1}))},promptLogin(){uni.showModal({title:"提示",content:"请先登录",confirmText:"去登录",success:e=>{e.confirm?uni.navigateTo({url:"/pages/login/login"}):uni.navigateBack()}})},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"change-phone-container"},[e.createElementVNode("view",{class:"phone-header"},[e.createElementVNode("view",{class:"header-title"},"更换手机号")]),e.createElementVNode("view",{class:"phone-form"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"当前手机号"),e.createElementVNode("view",{class:"current-phone"},e.toDisplayString(r.maskPhone(n.currentPhone)),1)]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"新手机号"),e.withDirectives(e.createElementVNode("input",{type:"number","onUpdate:modelValue":o[0]||(o[0]=e=>n.newPhone=e),placeholder:"请输入新手机号",class:"form-input",maxlength:"11","placeholder-style":"color: #666666;"},null,512),[[e.vModelText,n.newPhone]])]),e.createElementVNode("button",{class:"submit-btn",onClick:o[1]||(o[1]=(...e)=>r.submitChange&&r.submitChange(...e))},"确认更换")])])}]]);const I=i({data:()=>({userInfo:{},genderOptions:["请选择","男","女"],genderIndex:0,birthday:"",loading:!1}),onLoad(){this.checkLoginStatus(),this.getUserInfo()},methods:{checkLoginStatus(){uni.getStorageSync("token")||this.promptLogin()},getUserInfo(){const e=uni.getStorageSync("userInfo");e?(this.userInfo=e,e.gender&&(this.genderIndex=e.gender),e.birthday&&(this.birthday=e.birthday)):r.request({url:"/user/profile",method:"GET"}).then((e=>{200===e.data.code&&e.data.data&&(this.userInfo=e.data.data,uni.setStorageSync("userInfo",e.data.data),this.userInfo.gender&&(this.genderIndex=this.userInfo.gender),this.userInfo.birthday&&(this.birthday=this.userInfo.birthday))})).catch((e=>{t("error","at pages/user/user-info.vue:106","获取用户信息失败:",e)}))},maskPhone:e=>e&&11===e.length?e.substring(0,3)+"****"+e.substring(7):"",bindGenderChange(e){this.genderIndex=e.detail.value},bindDateChange(e){this.birthday=e.detail.value},submitUpdate(){0!==this.genderIndex?this.birthday?(this.loading=!0,r.request({url:"/user/profile",method:"PUT",data:{avatar:this.userInfo.avatar,gender:parseInt(this.genderIndex),birthday:this.birthday,phone:this.userInfo.phone}}).then((e=>{if(200===e.data.code){this.showToast("信息更新成功","success");const e=uni.getStorageSync("userInfo")||{};e.gender=parseInt(this.genderIndex),e.birthday=this.birthday,uni.setStorageSync("userInfo",e),setTimeout((()=>{uni.navigateBack()}),1500)}else this.showToast(e.data.message||"信息更新失败")})).catch((()=>{this.showToast("网络错误，请稍后再试")})).finally((()=>{this.loading=!1}))):this.showToast("请选择生日"):this.showToast("请选择性别")},promptLogin(){uni.showModal({title:"提示",content:"请先登录",confirmText:"去登录",success:e=>{e.confirm?uni.navigateTo({url:"/pages/login/login"}):uni.navigateBack()}})},showToast(e,t="none"){uni.showToast({title:e,icon:t})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"user-info-container"},[e.createElementVNode("view",{class:"info-header"},[e.createElementVNode("view",{class:"header-title"},"个人信息")]),e.createElementVNode("view",{class:"info-form"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"用户名"),e.createElementVNode("view",{class:"current-info"},e.toDisplayString(n.userInfo.username||""),1)]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"手机号"),e.createElementVNode("view",{class:"current-info"},e.toDisplayString(r.maskPhone(n.userInfo.phone)||""),1)]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"性别"),e.createElementVNode("picker",{onChange:o[0]||(o[0]=(...e)=>r.bindGenderChange&&r.bindGenderChange(...e)),value:n.genderIndex,range:n.genderOptions},[e.createElementVNode("view",{class:"picker-content"},[e.createElementVNode("text",{class:"picker-text"},e.toDisplayString(n.genderOptions[n.genderIndex]),1),e.createElementVNode("text",{class:"arrow"},">")])],40,["value","range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"生日"),e.createElementVNode("picker",{mode:"date",value:n.birthday,onChange:o[1]||(o[1]=(...e)=>r.bindDateChange&&r.bindDateChange(...e)),start:"1950-01-01",end:"2010-12-31"},[e.createElementVNode("view",{class:"picker-content"},[e.createElementVNode("text",{class:"picker-text"},e.toDisplayString(n.birthday||"请选择生日"),1),e.createElementVNode("text",{class:"arrow"},">")])],40,["value"])]),e.createElementVNode("button",{class:"submit-btn",onClick:o[2]||(o[2]=(...e)=>r.submitUpdate&&r.submitUpdate(...e))},"保存修改")])])}]]);const P=i({data(){const e=new Date;return{userInfo:{},memberInfo:{currentLevel:0,levelName:"普通会员",currentPoints:0,nextLevelPoints:1e3,pointsToNextLevel:1e3,discount:1,benefits:"无折扣"},memberLevelList:[],showMemberLevelModal:!1,pointRecords:[],pointPage:0,pointSize:10,hasMorePointRecords:!0,loadingPoints:!1,coupons:[],couponPage:0,couponSize:10,hasMoreCoupons:!0,loadingCoupons:!1,receivableCoupons:[],checkinInfo:{days:[],continuesDays:0,currentMonthDays:30},currentYear:e.getFullYear(),currentMonth:e.getMonth()+1,todayChecked:!1,calendarDays:[],activeTab:0,debugMode:!1,pointRules:[],showPointRules:!1,scrollHeight:0}},onLoad(){this.getUserInfo(),this.getMemberLevel(),this.getPointRecords(),this.getCoupons(),this.getReceivableCoupons(),this.getCheckinRecords(),this.generateCalendar(),this.getPointRules(),this.getMemberLevelList(),this.setScrollHeight()},onPullDownRefresh(){this.getUserInfo(),this.getMemberLevel(),this.getPointRecords(),this.getCoupons(),this.getReceivableCoupons(),this.getCheckinRecords(),setTimeout((()=>{uni.stopPullDownRefresh()}),1e3)},onReady(){this.setScrollHeight()},onShow(){this.setScrollHeight()},onResize(){this.setScrollHeight()},computed:{isToday(){const e=new Date,t=e.getDate();return o=>o===t&&this.currentMonth===e.getMonth()+1&&this.currentYear===e.getFullYear()}},methods:{setScrollHeight(){const e=this;uni.getSystemInfo({success:function(o){e.scrollHeight=o.windowHeight,t("log","at pages/user/member-center.vue:376","设置滚动区域高度:",e.scrollHeight)}})},async getUserInfo(){try{const e=await r.getUserInfo();e.data&&200===e.data.code&&(this.userInfo=e.data.data)}catch(e){t("error","at pages/user/member-center.vue:388","获取用户信息失败",e),uni.showToast({title:"获取用户信息失败",icon:"none"})}},async getMemberLevel(){try{const e=await r.request({url:"/user/member-level",method:"GET"});e.data&&200===e.data.code&&(this.memberInfo=e.data.data)}catch(e){t("error","at pages/user/member-center.vue:410","获取会员等级信息失败",e)}},handlePointsScrollToLower(){t("log","at pages/user/member-center.vue:416","积分记录滚动到底部"),this.hasMorePointRecords&&!this.loadingPoints&&this.loadMorePointRecords()},async getPointRecords(e=!1){if(!this.loadingPoints)try{this.loadingPoints=!0,e?this.pointPage++:(this.pointPage=0,this.pointRecords=[]);const o=await r.request({url:"/user/point-records",method:"GET",data:{page:this.pointPage,size:this.pointSize}});if(o.data&&200===o.data.code){const a=o.data.data;this.pointRecords=e?[...this.pointRecords,...a.content]:a.content,this.hasMorePointRecords=this.pointRecords.length<a.totalElements,t("log","at pages/user/member-center.vue:455","积分记录加载完成，是否还有更多:",this.hasMorePointRecords)}}catch(o){t("error","at pages/user/member-center.vue:458","获取积分记录失败",o),uni.showToast({title:"获取积分记录失败",icon:"none"})}finally{this.loadingPoints=!1}},loadMorePointRecords(){this.hasMorePointRecords&&!this.loadingPoints&&(t("log","at pages/user/member-center.vue:471","加载更多积分记录，当前页:",this.pointPage),this.getPointRecords(!0))},async getCoupons(e=!1){if(!this.loadingCoupons)try{this.loadingCoupons=!0,e?this.couponPage++:(this.couponPage=0,this.coupons=[]);const t=await r.request({url:"/user/coupons",method:"GET",data:{page:this.couponPage,size:this.couponSize}});if(t.data&&200===t.data.code){const o=t.data.data;if(o&&o.content)this.coupons=e?[...this.coupons,...o.content]:o.content,this.hasMoreCoupons=this.coupons.length<o.totalElements;else{const t=Array.isArray(o)?o:[];this.coupons=e?[...this.coupons,...t]:t,this.hasMoreCoupons=!1}this.coupons.sort(((e,t)=>{if(e.status!==t.status)return e.status-t.status;if(0===e.status){return(e.coupon?new Date(e.coupon.endTime).getTime():0)-(t.coupon?new Date(t.coupon.endTime).getTime():0)}const o=new Date(e.createdAt).getTime();return new Date(t.createdAt).getTime()-o}))}}catch(o){t("error","at pages/user/member-center.vue:545","获取优惠券失败",o),uni.showToast({title:"获取优惠券失败",icon:"none"})}finally{this.loadingCoupons=!1}},loadMoreCoupons(){this.hasMoreCoupons&&!this.loadingCoupons&&this.getCoupons(!0)},async getReceivableCoupons(){try{const e=await r.request({url:"/user/receivable-coupons",method:"GET"});e.data&&200===e.data.code&&(this.receivableCoupons=Array.isArray(e.data.data)?e.data.data:[],this.receivableCoupons.sort(((e,t)=>(e.endTime?new Date(e.endTime).getTime():0)-(t.endTime?new Date(t.endTime).getTime():0))))}catch(e){t("error","at pages/user/member-center.vue:581","获取可领取优惠券失败",e),uni.showToast({title:"获取可领取优惠券失败",icon:"none"})}},async receiveCoupon(e){try{const t=await r.request({url:`/user/receive-coupon/${e}`,method:"POST"});t.data&&200===t.data.code&&(uni.showToast({title:"领取成功",icon:"success"}),this.getReceivableCoupons(),this.getCoupons())}catch(o){t("error","at pages/user/member-center.vue:608","领取优惠券失败",o),uni.showToast({title:"领取失败，请稍后再试",icon:"none"})}},async getCheckinRecords(){try{const e=await r.request({url:"/member/checkin/records",method:"GET",data:{year:this.currentYear,month:this.currentMonth}});if(e.data&&200===e.data.code){this.checkinInfo=e.data.data;const t=(new Date).getDate();this.todayChecked=this.checkinInfo.days&&this.checkinInfo.days.includes(t)}}catch(e){t("error","at pages/user/member-center.vue:635","获取签到记录失败",e)}},generateCalendar(){const e=new Date(this.currentYear,this.currentMonth-1,1).getDay(),t=new Date(this.currentYear,this.currentMonth,0).getDate();this.calendarDays=Array(e).fill(null);for(let a=1;a<=t;a++)this.calendarDays.push(a);const o=42-this.calendarDays.length;o>0&&(this.calendarDays=[...this.calendarDays,...Array(o).fill(null)])},async handleCheckin(){if(!this.todayChecked)try{const e=await r.request({url:"/member/checkin",method:"POST"});if(e.data&&200===e.data.code){const t=e.data.data;uni.showToast({title:`签到成功，获得${t.points}积分`,icon:"success"}),this.todayChecked=!0,this.checkinInfo.continuesDays&&(this.checkinInfo.continuesDays+=1);const o=(new Date).getDate();this.checkinInfo.days&&!this.checkinInfo.days.includes(o)&&this.checkinInfo.days.push(o),this.getUserInfo(),this.getPointRecords()}}catch(e){t("error","at pages/user/member-center.vue:694","签到失败",e),uni.showToast({title:"签到失败，请稍后再试",icon:"none"})}},formatDate:e=>e?e.includes(":")?e.split(" ")[0]:e:"",formatAmount(e){if(!e)return"0";try{if(1===e.type){const t=Number(e.amount);return isNaN(t)?"0":t.toFixed(0)}if(2===e.type){const t=Number(e.amount);return isNaN(t)?"0.0":t<1?(10*t).toFixed(1):t.toFixed(1)}{const t=Number(e.amount);return isNaN(t)?"0":t.toFixed(1)}}catch(o){return t("error","at pages/user/member-center.vue:743","格式化金额出错",o,e),"0"}},getCouponStatusText(e){switch(e){case 0:return"可使用";case 1:return"已使用";case 2:return"已过期";default:return"未知状态"}},toggleDebug(){this.debugMode=!this.debugMode,this.debugMode&&uni.showToast({title:"已开启调试模式",icon:"none"})},getUnusedCouponCount(){return this.coupons&&this.coupons.length?this.coupons.filter((e=>0===e.status)).length:0},async getPointRules(){try{const e=await r.request({url:"/member/point-rules",method:"GET"});e.data&&200===e.data.code&&(this.pointRules=e.data.data||[])}catch(e){t("error","at pages/user/member-center.vue:795","获取积分规则失败",e)}},togglePointRules(){this.showPointRules=!this.showPointRules},async getMemberLevelList(){try{const e=await r.request({url:"/member/levels",method:"GET"});e.data&&200===e.data.code&&(this.memberLevelList=e.data.data||[],t("log","at pages/user/member-center.vue:814","会员等级列表:",this.memberLevelList))}catch(e){t("error","at pages/user/member-center.vue:817","获取会员等级列表失败",e)}},toggleMemberLevelModal(){this.showMemberLevelModal=!this.showMemberLevelModal}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"page-wrapper"},[e.createElementVNode("scroll-view",{"scroll-y":"",class:"member-center",style:e.normalizeStyle({height:n.scrollHeight+"px"})},[e.createElementVNode("view",{class:"member-header"},[e.createElementVNode("view",{class:"header-bg"}),e.createElementVNode("view",{class:"member-info"},[e.createElementVNode("image",{src:n.userInfo.avatar||"/static/tabbar/user.png",class:"avatar",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"info-content"},[e.createElementVNode("view",{class:"username"},e.toDisplayString(n.userInfo.username),1),e.createElementVNode("view",{class:"member-level"},[e.createElementVNode("text",{class:"level-name"},e.toDisplayString(n.memberInfo.levelName||"普通会员"),1),e.createElementVNode("text",{class:"level-desc"},e.toDisplayString(n.memberInfo.benefits||""),1),n.memberInfo.discount&&n.memberInfo.discount<1?(e.openBlock(),e.createElementBlock("text",{key:0,class:"discount-badge"},e.toDisplayString((10*n.memberInfo.discount).toFixed(1))+"折",1)):e.createCommentVNode("",!0)])])]),e.createElementVNode("view",{class:"point-rules-btn",onClick:o[0]||(o[0]=(...e)=>r.toggleMemberLevelModal&&r.toggleMemberLevelModal(...e))},[e.createElementVNode("text",{class:"point-rules-text"},"会员等级"),e.createElementVNode("text",{class:"point-rules-icon"},"?")])]),e.createElementVNode("view",{class:"data-card"},[e.createElementVNode("view",{class:"data-item"},[e.createElementVNode("text",{class:"data-value"},e.toDisplayString(n.userInfo.totalPoints||n.memberInfo.currentPoints||0),1),e.createElementVNode("text",{class:"data-label"},"我的积分")]),e.createElementVNode("view",{class:"divider"}),e.createElementVNode("view",{class:"data-item"},[e.createElementVNode("text",{class:"data-value"},e.toDisplayString(r.getUnusedCouponCount()),1),e.createElementVNode("text",{class:"data-label"},"可用优惠券")]),e.createElementVNode("view",{class:"divider"}),e.createElementVNode("view",{class:"data-item"},[e.createElementVNode("text",{class:"data-value"},e.toDisplayString(n.memberInfo.pointsToNextLevel||0),1),e.createElementVNode("text",{class:"data-label"},"升级还需")])]),e.createElementVNode("view",{class:"section checkin-section"},[e.createElementVNode("view",{class:"section-header"},[e.createElementVNode("text",{class:"section-title"},"每日签到"),e.createElementVNode("text",{class:"section-subtitle"},"已连续签到 "+e.toDisplayString(n.checkinInfo.continuesDays||0)+" 天",1)]),e.createElementVNode("view",{class:"checkin-calendar"},[e.createElementVNode("view",{class:"calendar-header"},[e.createElementVNode("text",null,e.toDisplayString(n.currentYear)+"年"+e.toDisplayString(n.currentMonth)+"月",1)]),e.createElementVNode("view",{class:"calendar-days"},[e.createElementVNode("view",{class:"weekday-row"},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(["日","一","二","三","四","五","六"],((t,o)=>e.createElementVNode("text",{key:o,class:"weekday"},e.toDisplayString(t),1))),64))]),e.createElementVNode("view",{class:"days-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.calendarDays,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["calendar-day",{empty:!t,checked:n.checkinInfo.days&&n.checkinInfo.days.includes(t),today:r.isToday(t)}])},[t?(e.openBlock(),e.createElementBlock("text",{key:0},e.toDisplayString(t),1)):e.createCommentVNode("",!0)],2)))),128))])])]),e.createElementVNode("button",{class:e.normalizeClass(["checkin-btn",{checked:n.todayChecked}]),disabled:n.todayChecked,onClick:o[1]||(o[1]=(...e)=>r.handleCheckin&&r.handleCheckin(...e))},e.toDisplayString(n.todayChecked?"今日已签到":"立即签到"),11,["disabled"])]),e.createElementVNode("view",{class:"tab-container"},[e.createElementVNode("view",{class:"tab-header"},[e.createElementVNode("view",{class:e.normalizeClass(["tab-item",{active:0===n.activeTab}]),onClick:o[3]||(o[3]=e=>n.activeTab=0)},[e.createTextVNode(" 积分记录 "),e.createElementVNode("text",{class:"point-rules-icon",onClick:o[2]||(o[2]=e.withModifiers(((...e)=>r.togglePointRules&&r.togglePointRules(...e)),["stop"]))},"?")],2),e.createElementVNode("view",{class:e.normalizeClass(["tab-item",{active:1===n.activeTab}]),onClick:o[4]||(o[4]=e=>n.activeTab=1)},"我的优惠券 ",2),e.createElementVNode("view",{class:e.normalizeClass(["tab-item",{active:2===n.activeTab}]),onClick:o[5]||(o[5]=e=>n.activeTab=2)},"可领优惠券",2)]),0===n.activeTab?(e.openBlock(),e.createElementBlock("scroll-view",{key:0,"scroll-y":"",class:"tab-content points-record",onScrolltolower:o[6]||(o[6]=(...e)=>r.handlePointsScrollToLower&&r.handlePointsScrollToLower(...e))},[0!==n.pointRecords.length||n.loadingPoints?(e.openBlock(),e.createElementBlock("view",{key:1,class:"record-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.pointRecords,(t=>(e.openBlock(),e.createElementBlock("view",{class:"record-item",key:t.id},[e.createElementVNode("view",{class:"record-info"},[e.createElementVNode("text",{class:"record-desc"},e.toDisplayString(t.description),1),e.createElementVNode("text",{class:"record-time"},e.toDisplayString(t.createdAt),1)]),e.createElementVNode("text",{class:e.normalizeClass(["record-points",t.point>0?"positive":"negative"])},e.toDisplayString(t.point>0?"+":"")+e.toDisplayString(t.point),3)])))),128)),n.loadingPoints?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-more"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0),!n.hasMorePointRecords&&n.pointRecords.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"no-more"},[e.createElementVNode("text",null,"— 已加载全部 —")])):e.createCommentVNode("",!0)])):(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-tip"},[e.createElementVNode("text",null,"暂无积分记录")]))],32)):e.createCommentVNode("",!0),1===n.activeTab?(e.openBlock(),e.createElementBlock("scroll-view",{key:1,"scroll-y":"",class:"tab-content my-coupons"},[0===n.coupons.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-tip"},[n.loadingCoupons?(e.openBlock(),e.createElementBlock("text",{key:0},"加载中...")):(e.openBlock(),e.createElementBlock("text",{key:1},"暂无优惠券"))])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"coupon-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.coupons,(t=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["coupon-item",{used:1===t.status,expired:2===t.status}]),key:t.id},[e.createElementVNode("view",{class:"coupon-left"},[e.createElementVNode("view",{class:"coupon-amount"},[t.coupon&&1===t.coupon.type?(e.openBlock(),e.createElementBlock("text",{key:0,class:"amount-prefix"},"¥")):e.createCommentVNode("",!0),e.createElementVNode("text",{class:"amount-value"},e.toDisplayString(r.formatAmount(t.coupon)),1),t.coupon&&2===t.coupon.type?(e.openBlock(),e.createElementBlock("text",{key:1,class:"amount-postfix"},"折")):e.createCommentVNode("",!0)]),t.coupon&&t.coupon.minConsumption>0?(e.openBlock(),e.createElementBlock("text",{key:0,class:"condition"},"满"+e.toDisplayString(t.coupon.minConsumption)+"元可用",1)):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"coupon-right"},[e.createElementVNode("text",{class:"coupon-name"},e.toDisplayString(t.coupon?t.coupon.name:"优惠券"),1),e.createElementVNode("text",{class:"coupon-time"},e.toDisplayString(r.formatDate(t.coupon?t.coupon.startTime:""))+" - "+e.toDisplayString(r.formatDate(t.coupon?t.coupon.endTime:"")),1),e.createElementVNode("text",{class:"coupon-status"},e.toDisplayString(t.statusText||r.getCouponStatusText(t.status)),1)]),n.debugMode?(e.openBlock(),e.createElementBlock("view",{key:0,class:"debug-info"},[e.createElementVNode("text",null,"原始数据: "+e.toDisplayString(JSON.stringify(t)),1)])):e.createCommentVNode("",!0)],2)))),128))])),n.hasMoreCoupons&&!n.loadingCoupons?(e.openBlock(),e.createElementBlock("view",{key:2,class:"load-more",onClick:o[7]||(o[7]=(...e)=>r.loadMoreCoupons&&r.loadMoreCoupons(...e))}," 加载更多 ")):e.createCommentVNode("",!0),n.loadingCoupons?(e.openBlock(),e.createElementBlock("view",{key:3,class:"loading"},"加载中...")):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),2===n.activeTab?(e.openBlock(),e.createElementBlock("scroll-view",{key:2,"scroll-y":"",class:"tab-content receivable-coupons"},[0===n.receivableCoupons.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-tip"},[e.createElementVNode("text",null,"暂无可领取的优惠券")])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"coupon-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.receivableCoupons,(t=>(e.openBlock(),e.createElementBlock("view",{class:"coupon-item receivable",key:t.id},[e.createElementVNode("view",{class:"coupon-left"},[e.createElementVNode("view",{class:"coupon-amount"},[1===t.type?(e.openBlock(),e.createElementBlock("text",{key:0,class:"amount-prefix"},"¥")):e.createCommentVNode("",!0),e.createElementVNode("text",{class:"amount-value"},e.toDisplayString(r.formatAmount(t)),1),2===t.type?(e.openBlock(),e.createElementBlock("text",{key:1,class:"amount-postfix"},"折")):e.createCommentVNode("",!0)]),t.minConsumption>0?(e.openBlock(),e.createElementBlock("text",{key:0,class:"condition"},"满"+e.toDisplayString(t.minConsumption)+"元可用",1)):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"coupon-right"},[e.createElementVNode("text",{class:"coupon-name"},e.toDisplayString(t.name||"优惠券"),1),e.createElementVNode("text",{class:"coupon-time"},e.toDisplayString(r.formatDate(t.startTime))+" - "+e.toDisplayString(r.formatDate(t.endTime)),1),e.createElementVNode("button",{class:"receive-btn",onClick:e.withModifiers((e=>r.receiveCoupon(t.id)),["stop"])},"领取",8,["onClick"])]),n.debugMode?(e.openBlock(),e.createElementBlock("view",{key:0,class:"debug-info"},[e.createElementVNode("text",null,"原始数据: "+e.toDisplayString(JSON.stringify(t)),1)])):e.createCommentVNode("",!0)])))),128))]))])):e.createCommentVNode("",!0)])],4),n.showMemberLevelModal?(e.openBlock(),e.createElementBlock("view",{key:0,class:"member-level-modal"},[e.createElementVNode("view",{class:"modal-mask",onClick:o[8]||(o[8]=(...e)=>r.toggleMemberLevelModal&&r.toggleMemberLevelModal(...e))}),e.createElementVNode("view",{class:"modal-content"},[e.createElementVNode("view",{class:"modal-header"},[e.createElementVNode("text",{class:"modal-title"},"会员等级与权益"),e.createElementVNode("text",{class:"modal-close",onClick:o[9]||(o[9]=(...e)=>r.toggleMemberLevelModal&&r.toggleMemberLevelModal(...e))},"×")]),e.createElementVNode("view",{class:"modal-body"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.memberLevelList,((t,o)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["level-item",{"current-level":t.level===n.memberInfo.currentLevel}]),key:o},[e.createElementVNode("view",{class:"level-header"},[e.createElementVNode("view",{class:"level-name"},[e.createElementVNode("text",null,e.toDisplayString(t.name),1),t.level===n.memberInfo.currentLevel?(e.openBlock(),e.createElementBlock("text",{key:0,class:"level-tag"},"当前等级")):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"level-points"},"所需积分: "+e.toDisplayString(t.pointThreshold)+"+",1)]),e.createElementVNode("view",{class:"level-benefits"},[e.createElementVNode("view",{class:"level-discount"},[e.createElementVNode("text",{class:"benefit-label"},"折扣权益:"),e.createElementVNode("text",{class:"benefit-value"},e.toDisplayString(1==t.discount?"无折扣":(10*t.discount).toFixed(1)+"折"),1)]),e.createElementVNode("view",{class:"level-other-benefits"},[e.createElementVNode("text",{class:"benefit-label"},"其他权益:"),e.createElementVNode("text",{class:"benefit-value"},e.toDisplayString(t.benefits||"无特殊权益"),1)])])],2)))),128)),0===n.memberLevelList.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-tip"},[e.createElementVNode("text",null,"暂无会员等级信息")])):e.createCommentVNode("",!0)])])])):e.createCommentVNode("",!0),n.showPointRules?(e.openBlock(),e.createElementBlock("view",{key:1,class:"point-rules-modal"},[e.createElementVNode("view",{class:"modal-mask",onClick:o[10]||(o[10]=(...e)=>r.togglePointRules&&r.togglePointRules(...e))}),e.createElementVNode("view",{class:"modal-content"},[e.createElementVNode("view",{class:"modal-header"},[e.createElementVNode("text",{class:"modal-title"},"积分获取规则"),e.createElementVNode("text",{class:"modal-close",onClick:o[11]||(o[11]=(...e)=>r.togglePointRules&&r.togglePointRules(...e))},"×")]),e.createElementVNode("view",{class:"modal-body"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.pointRules,((t,o)=>(e.openBlock(),e.createElementBlock("view",{class:"rule-item",key:o},[e.createElementVNode("view",{class:"rule-name"},e.toDisplayString(t.name),1),e.createElementVNode("view",{class:"rule-desc"},e.toDisplayString(t.description),1),t.isRatio?(e.openBlock(),e.createElementBlock("view",{key:0,class:"rule-value"}," 比例："+e.toDisplayString(100*t.pointValue)+"% ",1)):(e.openBlock(),e.createElementBlock("view",{key:1,class:"rule-value"}," 固定积分："+e.toDisplayString(t.pointValue)+"分 ",1))])))),128)),0===n.pointRules.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-tip"},[e.createElementVNode("text",null,"暂无积分规则")])):e.createCommentVNode("",!0)])])])):e.createCommentVNode("",!0)])}],["__scopeId","data-v-4542a870"]]);const M=i({data:()=>({orderNo:"",orderAmount:0,refundAmount:"",reasonOptions:["商品质量问题","商品口味不合适","送达时间过长","商品包装破损","商品错误","重复下单","不想要了","其他原因"],reasonIndex:0,methods:[{id:1,name:"原路返回"},{id:2,name:"退到余额"}],methodIndex:0,remark:""}),onLoad(e){e.orderNo&&(this.orderNo=e.orderNo),e.amount&&(this.orderAmount=parseFloat(e.amount),this.refundAmount=this.orderAmount.toFixed(2))},methods:{checkAmount(){if(this.refundAmount&&!/^\d+(\.\d{0,2})?$/.test(this.refundAmount)){const e=this.refundAmount;this.refundAmount=e.replace(/[^\d.]/g,"")}parseFloat(this.refundAmount)>this.orderAmount&&(this.refundAmount=this.orderAmount.toFixed(2),uni.showToast({title:"退款金额不能超过订单金额",icon:"none"}))},onReasonChange(e){this.reasonIndex=e.detail.value},onMethodChange(e){this.methodIndex=e.detail.value},submitRefund(){!this.refundAmount||parseFloat(this.refundAmount)<=0?uni.showToast({title:"请输入有效的退款金额",icon:"none"}):void 0!==this.reasonIndex?uni.showModal({title:"确认申请",content:"确定要提交退款申请吗？",success:e=>{if(e.confirm){uni.showLoading({title:"提交中..."});const e={orderNo:this.orderNo,refundAmount:parseFloat(this.refundAmount),reason:this.reasonOptions[this.reasonIndex],remark:this.remark,refundMethod:this.methods[this.methodIndex].id};t("log","at pages/order/refund.vue:182","退款请求数据:",e),t("log","at pages/order/refund.vue:183","订单支付金额:",this.orderAmount),r.applyRefund(e).then((e=>{t("log","at pages/order/refund.vue:188","退款申请响应:",e.data),200===e.data.code?(uni.showToast({title:"申请已提交",icon:"success"}),setTimeout((()=>{uni.navigateBack()}),1500)):uni.showToast({title:e.data.message||"申请失败",icon:"none"})})).catch((e=>{t("error","at pages/order/refund.vue:207","网络请求失败:",e),uni.showToast({title:"网络请求失败",icon:"none"})})).finally((()=>{uni.hideLoading()}))}}}):uni.showToast({title:"请选择退款原因",icon:"none"})}}},[["render",function(t,o,a,s,n,r){return e.openBlock(),e.createElementBlock("view",{class:"refund-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"申请退款")]),e.createElementVNode("view",{class:"refund-form"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"item-label"},"订单编号"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(n.orderNo),1)]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"item-label"},"退款金额"),e.createElementVNode("view",{class:"amount-input"},[e.createElementVNode("text",{class:"currency"},"¥"),e.withDirectives(e.createElementVNode("input",{type:"digit","onUpdate:modelValue":o[0]||(o[0]=e=>n.refundAmount=e),placeholder:"请输入退款金额",class:"amount-value",maxlength:10,onInput:o[1]||(o[1]=(...e)=>r.checkAmount&&r.checkAmount(...e))},null,544),[[e.vModelText,n.refundAmount]])])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"item-label"},"退款原因"),e.createElementVNode("picker",{onChange:o[2]||(o[2]=(...e)=>r.onReasonChange&&r.onReasonChange(...e)),value:n.reasonIndex,range:n.reasonOptions},[e.createElementVNode("view",{class:"picker-value"},[e.createElementVNode("text",null,e.toDisplayString(n.reasonOptions[n.reasonIndex]||"请选择退款原因"),1),e.createElementVNode("view",{class:"arrow"})])],40,["value","range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"item-label"},"退款方式"),e.createElementVNode("picker",{onChange:o[3]||(o[3]=(...e)=>r.onMethodChange&&r.onMethodChange(...e)),value:n.methodIndex,range:n.methods,"range-key":"name"},[e.createElementVNode("view",{class:"picker-value"},[e.createElementVNode("text",null,e.toDisplayString(n.methods[n.methodIndex].name||"请选择退款方式"),1),e.createElementVNode("view",{class:"arrow"})])],40,["value","range"])]),e.createElementVNode("view",{class:"form-item textarea-item"},[e.createElementVNode("text",{class:"item-label"},"备注说明"),e.withDirectives(e.createElementVNode("textarea",{"onUpdate:modelValue":o[4]||(o[4]=e=>n.remark=e),placeholder:"请输入退款说明（选填）",class:"remark-textarea",maxlength:"200"},null,512),[[e.vModelText,n.remark]]),e.createElementVNode("text",{class:"textarea-count"},e.toDisplayString(n.remark.length)+"/200",1)])]),e.createElementVNode("view",{class:"refund-tips"},[e.createElementVNode("view",{class:"tip-item"},[e.createElementVNode("text",{class:"tip-title"},"退款说明:"),e.createElementVNode("text",{class:"tip-content"},"1. 退款金额不能超过订单支付金额"),e.createElementVNode("text",{class:"tip-content"},"2. 提交后需等待商家审核，请耐心等待"),e.createElementVNode("text",{class:"tip-content"},"3. 退款将原路返回，预计1-7个工作日到账")])]),e.createElementVNode("view",{class:"submit-btn",onClick:o[5]||(o[5]=(...e)=>r.submitRefund&&r.submitRefund(...e))},"提交申请")])}]]);__definePage("pages/index/index",c),__definePage("pages/menu/menu",w),__definePage("pages/cart/cart",v),__definePage("pages/order/order",E),__definePage("pages/mine/mine",k),__definePage("pages/login/login",N),__definePage("pages/register/register",V),__definePage("pages/user/avatar-view",T),__definePage("pages/order/detail",x),__definePage("pages/order/confirm",b),__definePage("pages/menu/search",C),__definePage("pages/user/settings",S),__definePage("pages/user/change-password",B),__definePage("pages/user/change-phone",D),__definePage("pages/user/user-info",I),__definePage("pages/user/member-center",P),__definePage("pages/order/refund",M);const L={onShow:function(){t("log","at App.vue:4","App Show")},onHide:function(){t("log","at App.vue:7","App Hide")}};const{app:A,Vuex:F,Pinia:R}={app:e.createVueApp(L)};uni.Vuex=F,uni.Pinia=R,A.provide("__globalStyles",__uniConfig.styles),A._component.mpType="app",A._component.render=()=>{},A.mount("#app")}(Vue);
